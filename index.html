<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“è·¯å¤§äº¨ | RAILROAD TYCOON</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colorful Rainbow Style */
            --bg-void: #0d0d1a;
            --bg-card: #1a1a2e;
            --bg-muted: #252540;
            --fg-primary: #f0f0f0;
            --fg-secondary: #8888aa;
            --neon-green: #00ff88;
            --neon-magenta: #ff00ff;
            --neon-cyan: #00d4ff;
            --neon-orange: #ff6b00;
            --neon-yellow: #ffff00;
            --neon-red: #ff3366;
            --neon-purple: #9d4edd;
            --neon-pink: #ff69b4;
            --neon-blue: #4361ee;
            --border: #3a3a5a;
            --gradient-neon: linear-gradient(135deg, #ff0080 0%, #ff8c00 14%, #ffff00 28%, #00ff00 42%, #00ffff 56%, #0080ff 70%, #8000ff 84%, #ff0080 100%);
            --gradient-rainbow: linear-gradient(90deg, #ff0080, #ff8c00, #ffff00, #00ff00, #00ffff, #0080ff, #8000ff, #ff0080);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Base */
        body {
            font-family: 'JetBrains Mono', 'Share Tech Mono', monospace;
            background: var(--bg-void);
            min-height: 100vh;
            color: var(--fg-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* Scanline overlay */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.15) 2px,
                rgba(0, 0, 0, 0.15) 4px
            );
            pointer-events: none;
            z-index: 9999;
            animation: scanlines 8s linear infinite;
        }

        @keyframes progressGlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }
        
        @keyframes scanlines {
            0% { transform: translateY(0); }
            100% { transform: translateY(4px); }
        }

        /* Grid background - Rainbow */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, rgba(255, 0, 128, 0.03) 1px, transparent 1px),
                linear-gradient(rgba(0, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
            animation: rainbowGrid 10s linear infinite;
        }
        
        @keyframes rainbowGrid {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        /* Noise texture */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.03;
            pointer-events: none;
            z-index: 9998;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%' height='100%' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        .game-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: linear-gradient(180deg, rgba(18, 18, 26, 0.95) 0%, rgba(10, 10, 15, 0.9) 100%);
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Header corner decorations */
        .header::before,
        .header::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid var(--neon-pink);
            animation: cornerGlow 3s ease-in-out infinite;
        }
        .header::before { top: -1px; left: -1px; border-right: none; border-bottom: none; border-color: var(--neon-pink); }
        .header::after { bottom: -1px; right: -1px; border-left: none; border-top: none; border-color: var(--neon-cyan); }
        
        @keyframes cornerGlow {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(180deg); }
        }

        /* Animated border glow */
        .header-glow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gradient-neon);
            animation: borderGlow 3s ease-in-out infinite;
        }

        @keyframes borderGlow {
            0%, 100% { opacity: 0.5; transform: scaleX(0.5); }
            50% { opacity: 1; transform: scaleX(1); }
        }

        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 32px;
            font-weight: 900;
            letter-spacing: 4px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .game-title-main {
            background: var(--gradient-rainbow);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 0, 128, 0.5);
            animation: titleGlitch 5s infinite, rainbowText 5s linear infinite;
            background-size: 200% 100%;
        }
        
        @keyframes rainbowText {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        @keyframes titleGlitch {
            0%, 90%, 100% { transform: translate(0); filter: none; }
            91% { transform: translate(-2px, 1px); filter: hue-rotate(90deg); }
            92% { transform: translate(2px, -1px); filter: hue-rotate(-90deg); }
            93% { transform: translate(0); filter: none; }
        }

        .game-title-sub {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 8px;
            color: var(--neon-cyan);
            margin-top: 4px;
            opacity: 0.8;
        }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            background: rgba(0, 255, 136, 0.03);
            border: 1px solid rgba(0, 255, 136, 0.15);
            border-radius: 2px;
            transition: all 100ms steps(4);
            position: relative;
        }

        .stat-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 3px;
            height: 100%;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            opacity: 0;
            transition: opacity 100ms steps(2);
        }

        .stat-item:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2), inset 0 0 20px rgba(0, 255, 136, 0.05);
        }

        .stat-item:hover::before { opacity: 1; }

        .stat-icon {
            font-size: 20px;
            filter: drop-shadow(0 0 6px currentColor);
        }

        .stat-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 9px;
            letter-spacing: 2px;
            color: var(--fg-secondary);
            text-transform: uppercase;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 700;
            background: var(--gradient-rainbow); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% 100%; animation: rainbowText 3s linear infinite;
            text-shadow: 0 0 10px var(--neon-green);
        }

        .stat-item:nth-child(2) .stat-value { color: var(--neon-yellow); text-shadow: 0 0 10px var(--neon-yellow); }
        .stat-item:nth-child(3) .stat-value { color: var(--neon-magenta); text-shadow: 0 0 10px var(--neon-magenta); }
        .stat-item:nth-child(4) .stat-value { color: var(--neon-cyan); text-shadow: 0 0 10px var(--neon-cyan); }

        /* Main Layout */
        .main-content {
            display: grid;
            grid-template-columns: 260px 1fr 300px;
            gap: 20px;
        }

        /* Panels */
        .sidebar, .center-panel, .right-panel {
            background: linear-gradient(180deg, rgba(18, 18, 26, 0.9) 0%, rgba(12, 12, 18, 0.95) 100%);
            border: 1px solid var(--border);
            border-radius: 4px;
            position: relative;
        }

        /* Panel corner decorations */
        .sidebar::before, .center-panel::before, .right-panel::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            width: 10px;
            height: 10px;
            border-top: 2px solid var(--neon-green);
            border-left: 2px solid var(--neon-green);
        }

        .sidebar::after, .center-panel::after, .right-panel::after {
            content: '';
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 10px;
            height: 10px;
            border-bottom: 2px solid var(--neon-cyan);
            border-right: 2px solid var(--neon-cyan);
        }

        .sidebar { padding: 20px; }
        .center-panel { padding: 25px; min-height: 650px; }
        .right-panel { padding: 20px; }

        /* Section titles */
        .sidebar-title, .panel-title {
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            font-weight: 400;
            letter-spacing: 4px;
            background: var(--gradient-rainbow); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% 100%; animation: rainbowText 3s linear infinite;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* æŒ‰é’®åœ¨æ ‡é¢˜ä¸­æ—¶é‡ç½®æ–‡å­—æ•ˆæœ */
        .panel-title .btn {
            -webkit-text-fill-color: initial;
            background: transparent;
        }

        .sidebar-title::before {
            content: '> ';
            color: var(--neon-cyan);
        }

        /* Level display */
        .level-info {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05) 0%, rgba(0, 212, 255, 0.05) 100%);
            border: 1px solid rgba(0, 255, 136, 0.2);
            padding: 20px;
            border-radius: 2px;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }

        .level-label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            letter-spacing: 3px;
            color: var(--fg-secondary);
            margin-bottom: 8px;
        }

        .level-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 48px;
            font-weight: 900;
            background: var(--gradient-rainbow); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% 100%; animation: rainbowText 3s linear infinite;
            text-shadow: 0 0 30px var(--neon-green), 0 0 60px rgba(0, 255, 136, 0.3);
            line-height: 1;
        }

        .exp-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-muted);
            border-radius: 2px;
            margin-top: 15px;
            overflow: hidden;
            position: relative;
        }

        .exp-fill {
            height: 100%;
            background: var(--gradient-neon);
            border-radius: 2px;
            transition: width 150ms cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px var(--neon-green);
        }

        .exp-text {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            color: var(--fg-secondary);
            margin-top: 8px;
            letter-spacing: 1px;
        }

        /* Navigation */
        .nav-btn {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 6px;
            background: transparent;
            border: 1px solid transparent;
            border-left: 2px solid var(--border);
            border-radius: 0;
            color: var(--fg-secondary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 13px;
            cursor: pointer;
            transition: all 100ms steps(3);
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .nav-btn:hover {
            background: rgba(0, 255, 136, 0.05);
            border-left: 3px solid var(--neon-pink);
            color: var(--fg-primary);
            padding-left: 20px;
        }

        .nav-btn.active {
            background: linear-gradient(90deg, rgba(255, 105, 180, 0.15) 0%, rgba(157, 78, 221, 0.1) 50%, transparent 100%);
            border-left: 3px solid var(--neon-pink);
            color: transparent;
            background-image: var(--gradient-rainbow);
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200% 100%;
            animation: rainbowText 3s linear infinite;
            box-shadow: inset 0 0 20px rgba(255, 105, 180, 0.1);
        }

        .nav-btn.active::before {
            content: '>';
            position: absolute;
            left: 6px;
            color: transparent;
            background-image: var(--gradient-rainbow);
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200% 100%;
            animation: rainbowText 3s linear infinite;
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        /* Cards */
        .train-card, .employee-card, .running-train {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.02) 0%, rgba(0, 212, 255, 0.02) 100%);
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 100ms steps(3);
            position: relative;
            overflow: hidden;
        }

        .train-card::before, .employee-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: transparent;
            transition: background 100ms steps(2);
        }

        .train-card:hover, .employee-card:hover {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.15);
            transform: translateX(4px);
        }
        
        .train-card:hover .train-name, .employee-card:hover .employee-name {
            color: transparent;
            background-image: var(--gradient-rainbow);
            -webkit-background-clip: text;
            background-clip: text;
            background-size: 200% 100%;
            animation: rainbowText 3s linear infinite;
        }

        .train-card:hover::before, .employee-card:hover::before {
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
        }

        .train-card.selected {
            border-color: var(--neon-magenta);
            box-shadow: 0 0 25px rgba(255, 0, 255, 0.2);
        }

        .train-card.selected::before {
            background: var(--neon-magenta);
        }

        .train-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--fg-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .train-type {
            font-family: 'Share Tech Mono', monospace;
            font-size: 9px;
            font-weight: 400;
            padding: 3px 8px;
            border-radius: 1px;
            display: inline-block;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .type-normal { background: var(--neon-cyan); color: #000; }
        .type-intercity { background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple)); color: #000; }
        .type-highspeed { background: var(--neon-red); color: #fff; }
        .type-anime { background: var(--neon-magenta); color: #fff; }
        .type-zodiac { background: var(--neon-orange); color: #000; }

        .train-stats {
            display: flex;
            gap: 20px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            color: var(--fg-secondary);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            font-weight: 400;
            letter-spacing: 2px;
            transition: all 100ms steps(3);
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            color: #000;
            border: 1px solid var(--neon-pink);
        }

        .btn-primary:hover {
            box-shadow: 0 0 20px var(--neon-pink), 0 0 40px var(--neon-purple);
            text-shadow: none;
        }

        .btn-primary:disabled {
            background: var(--bg-muted);
            border-color: var(--border);
            color: var(--fg-secondary);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--neon-cyan);
            color: var(--neon-cyan);
        }

        .btn-secondary:hover {
            background: rgba(0, 212, 255, 0.1);
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.3);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 10px;
        }

        .btn-danger {
            background: transparent;
            border: 1px solid var(--neon-red);
            color: var(--neon-red);
        }

        .btn-danger:hover {
            background: rgba(255, 51, 102, 0.1);
            box-shadow: 0 0 15px rgba(255, 51, 102, 0.3);
        }

        /* Progress bars */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-muted);
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-neon);
            border-radius: 2px;
            transition: width 150ms cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 8px var(--neon-green);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .tab {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--fg-secondary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 100ms steps(3);
        }

        .tab:hover {
            border-color: var(--neon-cyan);
            color: var(--fg-primary);
        }

        .tab.active {
            background: rgba(0, 255, 136, 0.1);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        /* Form elements */
        select, input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 2px;
            color: var(--fg-primary);
            font-family: 'Share Tech Mono', monospace;
            font-size: 13px;
            margin: 8px 0;
            transition: all 100ms steps(3);
        }

        select:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }

        select option {
            background: var(--bg-card);
            color: var(--fg-primary);
        }

        /* Labels */
        label {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            letter-spacing: 2px;
            color: var(--fg-secondary);
            text-transform: uppercase;
            display: block;
            margin-bottom: 6px;
        }

        /* Shop grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 15px;
        }

        /* Section boxes */
        .section-box {
            background: rgba(0, 255, 136, 0.02);
            border: 1px solid var(--border);
            padding: 18px;
            border-radius: 2px;
            margin-bottom: 18px;
        }

        .section-title {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            font-weight: 400;
            letter-spacing: 3px;
            margin-bottom: 12px;
            color: var(--neon-cyan);
            text-transform: uppercase;
        }

        .section-title::before {
            content: '// ';
            background: var(--gradient-rainbow); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% 100%; animation: rainbowText 3s linear infinite;
        }

        /* Route info */
        .route-info {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.03) 0%, rgba(0, 212, 255, 0.03) 100%);
            border: 1px solid var(--border);
            padding: 20px;
            border-radius: 2px;
            margin-bottom: 20px;
        }

        .route-distance {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 700;
            background: var(--gradient-rainbow); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% 100%; animation: rainbowText 3s linear infinite;
            text-shadow: 0 0 20px var(--neon-green);
            text-align: center;
            margin: 15px 0;
        }

        .route-earnings {
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            text-align: center;
            margin: 10px 0;
        }

        .route-time {
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            color: var(--fg-secondary);
            text-align: center;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .modal.show { display: flex; }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--neon-pink);
            border-radius: 4px;
            padding: 30px;
            max-width: 480px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 0 50px rgba(255, 105, 180, 0.3);
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: var(--gradient-neon);
            border-radius: 4px;
            z-index: -1;
            opacity: 0.3;
            filter: blur(8px);
        }

        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            background: var(--gradient-rainbow); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% 100%; animation: rainbowText 3s linear infinite;
            text-align: center;
            letter-spacing: 2px;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple));
            border-radius: 2px;
            color: #000;
            font-family: 'Share Tech Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 1px;
            animation: notifySlide 0.3s steps(5);
            z-index: 10001;
            box-shadow: 0 0 30px var(--neon-pink);
        }

        @keyframes notifySlide {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Running train */
        .running-train {
            border-left: 2px solid var(--neon-green);
        }

        .train-route {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
        }

        /* Upgrade level */
        .upgrade-level {
            font-family: 'Orbitron', sans-serif;
            color: var(--neon-magenta);
            font-size: 12px;
            text-shadow: 0 0 8px var(--neon-magenta);
        }

        /* Income bonus */
        .income-bonus {
            font-family: 'Share Tech Mono', monospace;
            background: var(--gradient-rainbow); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; background-size: 200% 100%; animation: rainbowText 3s linear infinite;
            font-size: 11px;
            text-shadow: 0 0 6px var(--neon-green);
        }

        /* Save info */
        .save-info {
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            color: var(--fg-secondary);
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        /* Offline bonus */
        .offline-bonus {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), rgba(0, 212, 255, 0.05));
            border: 1px solid var(--neon-pink);
            padding: 25px;
            border-radius: 2px;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Employee type badges */
        .employee-type {
            font-family: 'Share Tech Mono', monospace;
            font-size: 9px;
            padding: 3px 8px;
            border-radius: 1px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .type-income { background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple)); color: #000; }
        .type-speed { background: var(--neon-cyan); color: #000; }
        .type-weight { background: var(--neon-red); color: #fff; }

        /* Responsive */
        @media screen and (max-width: 1200px) {
            .main-content { grid-template-columns: 240px 1fr 280px; gap: 15px; }
            .game-title-main { font-size: 26px; }
        }

        @media screen and (max-width: 992px) {
            .main-content { grid-template-columns: 1fr; gap: 15px; }
            .sidebar { order: 1; }
            .center-panel { order: 2; min-height: 450px; }
            .right-panel { order: 3; }
            .header { flex-direction: column; gap: 15px; text-align: center; }
            .stats-bar { justify-content: center; }
            .game-title-sub { display: none; }
        }

        @media screen and (max-width: 768px) {
            .game-container { padding: 10px; }
            .header { padding: 15px; }
            .game-title-main { font-size: 22px; }
            .stat-item { padding: 8px 12px; }
            .stat-value { font-size: 14px; }
            .center-panel { padding: 15px; min-height: 380px; }
            .shop-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 20px; }
        }

        @media screen and (max-width: 480px) {
            .game-title-main { font-size: 18px; }
            .stats-bar { gap: 6px; }
            .stat-item { padding: 6px 10px; flex: 1; min-width: 70px; justify-content: center; }
            .stat-icon { font-size: 16px; }
            .stat-value { font-size: 12px; }
            .nav-btn { padding: 10px 12px; font-size: 11px; }
            .level-value { font-size: 36px; }
            .train-card { padding: 12px; }
            .btn { padding: 8px 14px; font-size: 10px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-void); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple)); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    
    <div class="game-container">
        <div class="header">
            <div class="header-glow"></div>
            <div class="game-title">
                <span class="game-title-main">ğŸš‚ é“è·¯å¤§äº¨</span>
                <span class="game-title-sub">RAILROAD TYCOON v2.0</span>
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <span class="stat-icon">â­</span>
                    <div>
                        <div class="stat-label">Level</div>
                        <div class="stat-value" id="playerLevel">1</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸ’°</span>
                    <div>
                        <div class="stat-label">Gold</div>
                        <div class="stat-value" id="gold">0</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸ«</span>
                    <div>
                        <div class="stat-label">Points</div>
                        <div class="stat-value" id="points">0</div>
                        <div class="income-bonus" id="incomeBonus">+0%</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸš‚</span>
                    <div>
                        <div class="stat-label">Running</div>
                        <div class="stat-value" id="runningCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="sidebar-title">Navigation</div>
                <div class="level-info">
                    <div class="level-label">Current Level</div>
                    <div class="level-value" id="sidebarLevel">1</div>
                    <div class="exp-bar"><div class="exp-fill" id="expBar" style="width:0%"></div></div>
                    <div class="exp-text" id="expText">0 / 100 XP</div>
                </div>
                <button class="nav-btn active" onclick="showPanel('trains')">ğŸš‚ ç«è½¦ç®¡ç†</button>
                <button class="nav-btn" onclick="showPanel('routes')">ğŸ›¤ï¸ è·¯çº¿è§„åˆ’</button>
                <button class="nav-btn" onclick="showPanel('employees')">ğŸ‘¥ å‘˜å·¥ç®¡ç†</button>
                <button class="nav-btn" onclick="showPanel('shop')">ğŸª ç«è½¦å•†åº—</button>
                <button class="nav-btn" onclick="showPanel('running')">ğŸ“Š è¿è¥çŠ¶æ€</button>
                <button class="nav-btn" onclick="showPanel('map')">ğŸ—ºï¸ åœ°å›¾ç³»ç»Ÿ</button>
                <button class="nav-btn" onclick="showPanel('cities')">ğŸ™ï¸ åŸå¸‚è§£é”</button>
                <button class="nav-btn" onclick="showPanel('upgrade')">ğŸ”§ ç‚¹å·å¼ºåŒ–</button>
                <button class="nav-btn" onclick="showPanel('redeem')">ğŸ å…‘æ¢ç </button>
                <button class="nav-btn" onclick="showPanel('reform')">ğŸ’ ç«è½¦æ”¹é€ </button>
                <div class="save-info">
                    <button class="btn btn-secondary btn-small" onclick="manualSave()" style="width:100%;margin-bottom:8px;">ğŸ’¾ æ‰‹åŠ¨ä¿å­˜</button>
                    <button class="btn btn-danger btn-small" onclick="confirmRestart()" style="width:100%;">ğŸ”„ é‡æ–°å¼€å§‹</button>
                    <div id="lastSave" style="margin-top:10px;">ä¸Šæ¬¡ä¿å­˜: --</div>
                    <div id="dailyPointsInfo" style="margin-top:5px;color:var(--neon-cyan);"></div>
                    <div id="weatherDisplay" style="margin-top:8px;padding:8px;background:rgba(0,0,0,0.3);border-radius:8px;text-align:center;">
                        <div style="font-size:11px;color:var(--fg-secondary);">å½“å‰å¤©æ°”</div>
                        <div id="weatherInfo" style="font-size:14px;margin-top:4px;">â˜€ï¸ æ™´å¤©</div>
                        <div id="weatherEffect" style="font-size:10px;color:var(--neon-yellow);margin-top:4px;"></div>
                        <div id="weatherTimer" style="font-size:10px;color:var(--fg-secondary);margin-top:4px;"></div>
                    </div>
                </div>
            </div>

            <div class="center-panel">
                <div id="trainsPanel" class="panel">
                    <div class="panel-title"><span>æˆ‘çš„ç«è½¦</span><span style="font-size:10px;color:var(--fg-secondary);"><span id="trainCountInfo"></span></span></div>
                    <div id="trainList"></div>
                </div>

                <div id="routesPanel" class="panel" style="display:none;">
                    <div class="panel-title">è·¯çº¿è§„åˆ’</div>
                    <div class="route-info">
                        <div style="margin-bottom:15px;">
                            <label>é€‰æ‹©ç«è½¦</label>
                            <select id="routeTrainSelect" onchange="updateRouteInfo()"><option value="">-- è¯·é€‰æ‹©ç«è½¦ --</option></select>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label>å‡ºå‘åŸå¸‚</label>
                            <select id="startCitySelect" onchange="onStartCityChange()"><option value="">-- è¯·é€‰æ‹©å‡ºå‘åŸå¸‚ --</option></select>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label>åˆ°è¾¾åŸå¸‚</label>
                            <select id="endCitySelect" onchange="onEndCityChange()"><option value="">-- è¯·é€‰æ‹©åˆ°è¾¾åŸå¸‚ --</option></select>
                        </div>
                        <div class="route-distance" id="routeDistance"></div>
                        <div class="route-earnings" id="routeEarnings"></div>
                        <div class="route-time" id="routeTime"></div>
                    </div>
                    <div style="text-align:center;">
                        <button class="btn btn-primary" id="startRouteBtn" onclick="startRoute()" disabled style="padding:15px 40px;">å¼€å§‹è¿è¥</button>
                    </div>
                </div>

                <div id="employeesPanel" class="panel" style="display:none;">
                    <div class="panel-title"><span>å‘˜å·¥ç®¡ç†</span><button class="btn btn-secondary" onclick="hireEmployee()">æ‹›è˜ (1000é‡‘å¸)</button></div>
                    <div class="section-box">
                        <div class="section-title">é€‰æ‹©å‘˜å·¥æŸ¥çœ‹è¯¦æƒ…</div>
                        <select id="employeeSelect" onchange="showEmployeeDetail()"><option value="">-- è¯·é€‰æ‹©å‘˜å·¥ --</option></select>
                    </div>
                    <div id="employeeDetail"></div>
                </div>

                <div id="shopPanel" class="panel" style="display:none;">
                    <div class="panel-title">ç«è½¦å•†åº—</div>
                    <div class="tabs">
                        <button class="tab active" onclick="showShopTab('normal')">æ™®é€šç«è½¦</button>
                        <button class="tab" onclick="showShopTab('intercity')">åŸé™…åˆ—è½¦</button>
                        <button class="tab" onclick="showShopTab('highspeed')">é«˜é“</button>
                        <button class="tab" onclick="showShopTab('anime')">åŠ¨æ¼«è”å</button>
                        <button class="tab" onclick="showShopTab('zodiac')">ç”Ÿè‚–é™å®š</button>
                    </div>
                    <div id="shopList" class="shop-grid"></div>
                </div>

                <div id="runningPanel" class="panel" style="display:none;">
                    <div class="panel-title">è¿è¥çŠ¶æ€</div>
                    <div id="runningTrainList"></div>
                </div>

                <div id="mapPanel" class="panel" style="display:none;">
                    <div class="panel-title">åœ°å›¾ç³»ç»Ÿ</div>
                    <div class="tabs">
                        <button class="tab active" onclick="showMapTab('china')">ä¸­å›½åœ°å›¾</button>
                        <button class="tab" onclick="showMapTab('world')">ä¸–ç•Œåœ°å›¾</button>
                    </div>
                    <div id="mapContainer" style="position:relative;width:100%;height:900px;background:linear-gradient(135deg, rgba(0,255,136,0.03) 0%, rgba(0,212,255,0.03) 50%, rgba(255,0,255,0.02) 100%);border:1px solid var(--border);border-radius:4px;overflow:hidden;box-shadow:0 0 30px rgba(0,255,136,0.1), inset 0 0 50px rgba(0,0,0,0.3);">
                        <canvas id="mapCanvas" style="width:100%;height:100%;cursor:grab;"></canvas>
                        
                        <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
                        <div id="mapControls" style="position:absolute;top:15px;right:15px;display:flex;flex-direction:column;gap:8px;">
                            <button class="btn btn-secondary btn-small" onclick="zoomInMap()" style="width:40px;height:40px;padding:0;font-size:20px;font-weight:700;border-width:2px;box-shadow:0 0 15px rgba(0,212,255,0.3);">+</button>
                            <button class="btn btn-secondary btn-small" onclick="zoomOutMap()" style="width:40px;height:40px;padding:0;font-size:20px;font-weight:700;border-width:2px;box-shadow:0 0 15px rgba(0,212,255,0.3);">âˆ’</button>
                            <button class="btn btn-secondary btn-small" onclick="resetMapZoom()" style="width:40px;height:40px;padding:0;font-size:16px;border-width:2px;box-shadow:0 0 15px rgba(0,212,255,0.3);">âŸ²</button>
                        </div>
                        
                        <!-- ç¼©æ”¾çº§åˆ«æ˜¾ç¤º -->
                        <div id="mapZoomLevel" style="position:absolute;bottom:15px;right:15px;background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(18,18,26,0.9));padding:8px 14px;border-radius:3px;font-size:12px;color:var(--neon-cyan);font-family:'Orbitron',sans-serif;font-weight:700;border:1px solid rgba(0,212,255,0.3);box-shadow:0 0 15px rgba(0,212,255,0.2);">100%</div>
                        
                        <!-- åœ°å›¾æ ‡é¢˜ -->
                        <div style="position:absolute;top:15px;left:15px;background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(18,18,26,0.9));padding:10px 20px;border-radius:3px;border:1px solid rgba(0,255,136,0.3);box-shadow:0 0 20px rgba(0,255,136,0.2);">
                            <div style="font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;color:var(--neon-green);text-shadow:0 0 10px var(--neon-green);letter-spacing:2px;" id="mapTitle">CHINA MAP</div>
                            <div style="font-size:10px;color:var(--fg-secondary);margin-top:4px;font-family:'Share Tech Mono',monospace;">å®æ—¶è¿è¥ç›‘æ§ç³»ç»Ÿ</div>
                        </div>
                    </div>
                    
                    <!-- å›¾ä¾‹è¯´æ˜ -->
                    <div id="mapLegend" style="margin-top:20px;padding:20px;background:linear-gradient(135deg, rgba(0,255,136,0.03), rgba(0,212,255,0.02));border:1px solid var(--border);border-radius:4px;box-shadow:0 0 20px rgba(0,255,136,0.05);">
                        <div style="font-size:12px;color:var(--neon-cyan);margin-bottom:15px;letter-spacing:3px;font-family:'Orbitron',sans-serif;font-weight:600;">// å›¾ä¾‹è¯´æ˜</div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;">
                            <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,255,136,0.03);border-radius:3px;border:1px solid rgba(0,255,136,0.1);">
                                <div style="width:12px;height:12px;border-radius:50%;background:var(--neon-green);box-shadow:0 0 10px var(--neon-green);"></div>
                                <span style="font-size:12px;color:var(--fg-primary);">å·²è§£é”åŸå¸‚</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(107,114,128,0.03);border-radius:3px;border:1px solid rgba(107,114,128,0.1);">
                                <div style="width:10px;height:10px;border-radius:50%;background:var(--fg-secondary);"></div>
                                <span style="font-size:12px;color:var(--fg-primary);">æœªè§£é”åŸå¸‚</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(0,212,255,0.03);border-radius:3px;border:1px solid rgba(0,212,255,0.1);">
                                <div style="width:30px;height:3px;background:var(--neon-cyan);box-shadow:0 0 10px var(--neon-cyan);"></div>
                                <span style="font-size:12px;color:var(--fg-primary);">è¿è¥ä¸­è·¯çº¿</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,0,255,0.03);border-radius:3px;border:1px solid rgba(255,0,255,0.1);">
                                <div style="width:12px;height:12px;border-radius:50%;background:var(--neon-magenta);box-shadow:0 0 10px var(--neon-magenta);"></div>
                                <span style="font-size:12px;color:var(--fg-primary);">è¿è¥ä¸­ç«è½¦</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¿è¥ç»Ÿè®¡ -->
                    <div id="mapStats" style="margin-top:20px;padding:20px;background:linear-gradient(135deg, rgba(0,255,136,0.03), rgba(0,212,255,0.02));border:1px solid var(--border);border-radius:4px;box-shadow:0 0 20px rgba(0,255,136,0.05);">
                        <div style="font-size:12px;color:var(--neon-cyan);margin-bottom:15px;letter-spacing:3px;font-family:'Orbitron',sans-serif;font-weight:600;">// è¿è¥ç»Ÿè®¡</div>
                        <div id="mapStatsContent" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;"></div>
                    </div>
                </div>

                <div id="citiesPanel" class="panel" style="display:none;">
                    <div class="panel-title">åŸå¸‚è§£é”</div>
                    <div id="cityUnlockList"></div>
                </div>

                <div id="upgradePanel" class="panel" style="display:none;">
                    <div class="panel-title">ç‚¹å·å¼ºåŒ–</div>
                    <div class="section-box">
                        <div style="text-align:center;margin-bottom:20px;">
                            <div class="section-title" style="margin-bottom:10px;">å½“å‰æ”¶ç›ŠåŠ æˆ</div>
                            <div style="font-size:42px;font-family:'Orbitron',sans-serif;font-weight:900;color:var(--neon-green);text-shadow:0 0 30px var(--neon-green);" id="currentBonus">+0%</div>
                        </div>
                        <div style="text-align:center;">
                            <button class="btn btn-primary" id="upgradeBonusBtn" onclick="upgradeIncomeBonus()">æ¶ˆè€— 3000 ç‚¹å·æå‡ 1%</button>
                        </div>
                    </div>
                    <div class="panel-title" style="margin-top:25px;">ç«è½¦æ”¹é€ </div>
                    <div class="section-box">
                        <div class="section-title">é€‰æ‹©ç«è½¦è¿›è¡Œæ”¹é€ </div>
                        <select id="trainUpgradeSelect" onchange="showTrainUpgradeDetail()"><option value="">-- è¯·é€‰æ‹©ç«è½¦ --</option></select>
                    </div>
                    <div id="trainUpgradeDetail"></div>
                </div>

                <div id="redeemPanel" class="panel" style="display:none;">
                    <div class="panel-title">å…‘æ¢ç </div>
                    <div class="section-box">
                        <div class="section-title">è¾“å…¥å…‘æ¢ç </div>
                        <input type="text" id="redeemCodeInput" placeholder="è¯·è¾“å…¥å…‘æ¢ç ">
                        <button class="btn btn-primary" onclick="redeemCode()" style="width:100%;margin-top:12px;">å…‘æ¢</button>
                    </div>
                    <div id="redeemHistory" style="margin-top:20px;"></div>
                </div>

                <div id="reformPanel" class="panel" style="display:none;">
                    <div class="panel-title"><span>ç«è½¦æ”¹é€ </span><span style="font-size:11px;color:var(--fg-secondary);">æ”¹é€ çŸ³: <span id="reformStonesCount" style="color:var(--neon-magenta);">0</span> | ä»Šæ—¥è·å–: <span id="dailyReformStones" style="color:var(--neon-cyan);">0</span>/300</span></div>
                    <div class="section-box">
                        <div class="section-title">é€‰æ‹©è¦æ”¹é€ çš„ç«è½¦</div>
                        <select id="reformTrainSelect" onchange="updateReformInfo()"><option value="">-- è¯·é€‰æ‹©ç«è½¦ --</option></select>
                    </div>
                    <div id="reformTrainInfo" style="margin-top:20px;"></div>
                </div>
            </div>

            <div class="right-panel">
                <div class="sidebar-title">Real-time Status</div>
                <div id="runningInfo"><div style="color:var(--fg-secondary);text-align:center;padding:30px;font-size:12px;">æš‚æ— è¿è¥ä¸­çš„ç«è½¦</div></div>
            </div>
        </div>
    </div>

    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">åˆ†é…å‘˜å·¥</div>
            <div id="assignEmployeeList"></div>
            <button class="btn btn-secondary" onclick="closeModal()" style="width:100%;margin-top:20px;">å…³é—­</button>
        </div>
    </div>

    <div id="offlineModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">æ¬¢è¿å›æ¥!</div>
            <div class="offline-bonus">
                <div style="font-size:48px;margin-bottom:15px;">ğŸ’°</div>
                <div class="section-title" style="margin-bottom:10px;">ç¦»çº¿æ”¶ç›Š</div>
                <div style="font-size:32px;font-family:'Orbitron',sans-serif;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green);" id="offlineEarnings">0</div>
            </div>
            <button class="btn btn-primary" onclick="closeOfflineModal()" style="width:100%;">é¢†å–</button>
        </div>
    </div>

    <div id="unlockCityModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">è§£é”åŸå¸‚</div>
            <div id="unlockCityInfo"></div>
            <div style="display:flex;gap:12px;margin-top:20px;">
                <button class="btn btn-primary" id="confirmUnlockBtn" onclick="confirmUnlockCity()" style="flex:1;">ç¡®è®¤è§£é”</button>
                <button class="btn btn-secondary" onclick="closeUnlockModal()" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="lockCityModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">å…³é—­åŸå¸‚</div>
            <div id="lockCityInfo"></div>
            <div style="display:flex;gap:12px;margin-top:20px;">
                <button class="btn btn-danger" id="confirmLockBtn" onclick="confirmLockCity()" style="flex:1;">ç¡®è®¤å…³é—­</button>
                <button class="btn btn-secondary" onclick="closeLockModal()" style="flex:1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

        <div id="restartModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">âš ï¸ é‡æ–°å¼€å§‹æ¸¸æˆ</div>
            <div style="text-align:center;margin-bottom:20px;">
                <div style="font-size:64px;margin-bottom:15px;">ğŸ”„</div>
                <div style="color:var(--neon-red);font-size:16px;margin-bottom:10px;">ç¡®å®šè¦é‡æ–°å¼€å§‹å—ï¼Ÿ</div>
                <div style="color:var(--fg-secondary);font-size:13px;">æ‰€æœ‰æ¸¸æˆæ•°æ®å°†è¢«æ¸…ç©ºï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼</div>
            </div>
            <div style="display:flex;gap:12px;">
                <button class="btn btn-danger" style="flex:1;" onclick="restartGame()">ç¡®è®¤é‡æ–°å¼€å§‹</button>
                <button class="btn btn-secondary" style="flex:1;" onclick="closeRestartModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== åŸå¸‚æ•°æ® ====================
        const cities = {
            china: [
                { name: "å¹¿å·", lat: 23.1291, lng: 113.2644, displayLat: 22, displayLng: 114, unlockLevel: 1, unlockCost: 0 },
                { name: "æ·±åœ³", lat: 22.5431, lng: 114.0579, displayLat: 20, displayLng: 116, unlockLevel: 1, unlockCost: 0 },
                { name: "ä½›å±±", lat: 23.0218, lng: 113.1219, displayLat: 24, displayLng: 111, unlockLevel: 2, unlockCost: 5000 },
                { name: "ä¸œè", lat: 23.0207, lng: 113.7518, displayLat: 23, displayLng: 117, unlockLevel: 2, unlockCost: 5000 },
                { name: "ç æµ·", lat: 22.2707, lng: 113.5767, displayLat: 19, displayLng: 112, unlockLevel: 3, unlockCost: 10000 },
                { name: "ä¸­å±±", lat: 22.5170, lng: 113.3927, displayLat: 21, displayLng: 110, unlockLevel: 3, unlockCost: 10000 },
                { name: "æƒ å·", lat: 23.1115, lng: 114.4152, displayLat: 25, displayLng: 118, unlockLevel: 4, unlockCost: 15000 },
                { name: "æ±Ÿé—¨", lat: 22.5787, lng: 113.0949, displayLat: 18, displayLng: 109, unlockLevel: 4, unlockCost: 15000 },
                { name: "æ±•å¤´", lat: 23.3540, lng: 116.6824, displayLat: 26, displayLng: 122, unlockLevel: 5, unlockCost: 200000 },
                { name: "æ¹›æ±Ÿ", lat: 21.2707, lng: 110.3594, displayLat: 17, displayLng: 105, unlockLevel: 5, unlockCost: 200000 },
                { name: "èŒ‚å", lat: 21.6618, lng: 110.9178, displayLat: 16, displayLng: 107, unlockLevel: 6, unlockCost: 300000 },
                { name: "æµ·å£", lat: 20.0440, lng: 110.1999, displayLat: 14, displayLng: 103, unlockLevel: 6, unlockCost: 300000 },
                { name: "ä¸‰äºš", lat: 18.2528, lng: 109.5120, displayLat: 12, displayLng: 100, unlockLevel: 7, unlockCost: 400000 },
                { name: "å—å®", lat: 22.8170, lng: 108.3665, displayLat: 20, displayLng: 98, unlockLevel: 7, unlockCost: 400000 },
                { name: "é•¿æ²™", lat: 28.2282, lng: 112.9388, displayLat: 32, displayLng: 108, unlockLevel: 8, unlockCost: 500000 },
                { name: "æ ªæ´²", lat: 27.8274, lng: 113.1342, displayLat: 30, displayLng: 110, unlockLevel: 8, unlockCost: 500000 },
                { name: "æ¹˜æ½­", lat: 27.8503, lng: 112.9074, displayLat: 31, displayLng: 106, unlockLevel: 9, unlockCost: 600000 },
                { name: "å²³é˜³", lat: 29.3570, lng: 113.0966, displayLat: 34, displayLng: 111, unlockLevel: 9, unlockCost: 600000 },
                { name: "è¡¡é˜³", lat: 26.8968, lng: 112.5857, displayLat: 28, displayLng: 104, unlockLevel: 10, unlockCost: 800000 },
                { name: "æ­¦æ±‰", lat: 30.5928, lng: 114.3055, displayLat: 35, displayLng: 114, unlockLevel: 10, unlockCost: 800000 },
                { name: "å—æ˜Œ", lat: 28.6820, lng: 115.8579, displayLat: 33, displayLng: 118, unlockLevel: 11, unlockCost: 1000000 },
                { name: "ç¦å·", lat: 26.0745, lng: 119.2965, displayLat: 29, displayLng: 124, unlockLevel: 11, unlockCost: 1000000 },
                { name: "å¦é—¨", lat: 24.4798, lng: 118.0894, displayLat: 27, displayLng: 122, unlockLevel: 12, unlockCost: 1200000 },
                // å°æ¹¾çœåŸå¸‚
                { name: "å°åŒ—", lat: 25.0330, lng: 121.5654, displayLat: 28, displayLng: 128, unlockLevel: 12, unlockCost: 1200000 },
                { name: "æ–°åŒ—", lat: 25.0122, lng: 121.4654, displayLat: 27, displayLng: 127, unlockLevel: 13, unlockCost: 1500000 },
                { name: "åŸºéš†", lat: 25.1276, lng: 121.7392, displayLat: 29, displayLng: 129, unlockLevel: 13, unlockCost: 1500000 },
                { name: "æ¡ƒå›­", lat: 24.9936, lng: 121.3010, displayLat: 26, displayLng: 126, unlockLevel: 14, unlockCost: 1800000 },
                { name: "æ–°ç«¹", lat: 24.8138, lng: 120.9675, displayLat: 25, displayLng: 125, unlockLevel: 14, unlockCost: 1800000 },
                { name: "å°ä¸­", lat: 24.1477, lng: 120.6736, displayLat: 24, displayLng: 124, unlockLevel: 15, unlockCost: 2000000 },
                { name: "å½°åŒ–", lat: 24.0518, lng: 120.5161, displayLat: 23, displayLng: 123, unlockLevel: 15, unlockCost: 2000000 },
                { name: "å˜‰ä¹‰", lat: 23.4801, lng: 120.4491, displayLat: 22, displayLng: 122, unlockLevel: 16, unlockCost: 2500000 },
                { name: "å°å—", lat: 22.9999, lng: 120.2269, displayLat: 21, displayLng: 121, unlockLevel: 16, unlockCost: 2500000 },
                { name: "é«˜é›„", lat: 22.6273, lng: 120.3014, displayLat: 20, displayLng: 122, unlockLevel: 17, unlockCost: 3000000 },
                { name: "å±ä¸œ", lat: 22.6820, lng: 120.4900, displayLat: 19, displayLng: 123, unlockLevel: 17, unlockCost: 3000000 },
                { name: "èŠ±è²", lat: 23.9871, lng: 121.6015, displayLat: 26, displayLng: 128, unlockLevel: 18, unlockCost: 3500000 },
                { name: "å°ä¸œ", lat: 22.7583, lng: 121.1444, displayLat: 22, displayLng: 126, unlockLevel: 18, unlockCost: 3500000 },
                { name: "æ¸©å·", lat: 28.0006, lng: 120.6993, displayLat: 31, displayLng: 126, unlockLevel: 12, unlockCost: 1200000 },
                { name: "å®æ³¢", lat: 29.8683, lng: 121.5440, displayLat: 34, displayLng: 128, unlockLevel: 13, unlockCost: 1500000 },
                { name: "æ­å·", lat: 30.2741, lng: 120.1551, displayLat: 33, displayLng: 124, unlockLevel: 13, unlockCost: 1500000 },
                { name: "ç»å…´", lat: 30.0005, lng: 120.5820, displayLat: 32, displayLng: 126, unlockLevel: 14, unlockCost: 1800000 },
                { name: "å˜‰å…´", lat: 30.7468, lng: 120.7507, displayLat: 35, displayLng: 127, unlockLevel: 14, unlockCost: 1800000 },
                { name: "é‡‘å", lat: 29.0789, lng: 119.6478, displayLat: 30, displayLng: 123, unlockLevel: 15, unlockCost: 2000000 },
                { name: "å°å·", lat: 28.6563, lng: 121.4209, displayLat: 29, displayLng: 127, unlockLevel: 15, unlockCost: 2000000 },
                { name: "ä¸Šæµ·", lat: 31.2304, lng: 121.4737, displayLat: 36, displayLng: 130, unlockLevel: 16, unlockCost: 2500000 },
                { name: "è‹å·", lat: 31.2990, lng: 120.5853, displayLat: 37, displayLng: 128, unlockLevel: 16, unlockCost: 2500000 },
                { name: "æ— é”¡", lat: 31.4912, lng: 120.3119, displayLat: 38, displayLng: 126, unlockLevel: 17, unlockCost: 3000000 },
                { name: "å¸¸å·", lat: 31.8122, lng: 119.9692, displayLat: 39, displayLng: 124, unlockLevel: 17, unlockCost: 3000000 },
                { name: "å—äº¬", lat: 32.0603, lng: 118.7969, displayLat: 38, displayLng: 120, unlockLevel: 18, unlockCost: 3500000 },
                { name: "åˆè‚¥", lat: 31.8206, lng: 117.2272, displayLat: 36, displayLng: 116, unlockLevel: 18, unlockCost: 3500000 },
                { name: "éƒ‘å·", lat: 34.7466, lng: 113.6254, displayLat: 40, displayLng: 112, unlockLevel: 19, unlockCost: 4000000 },
                { name: "æµå—", lat: 36.6512, lng: 116.9972, displayLat: 42, displayLng: 118, unlockLevel: 19, unlockCost: 4000000 },
                { name: "é’å²›", lat: 36.0671, lng: 120.3826, displayLat: 41, displayLng: 124, unlockLevel: 20, unlockCost: 5000000 },
                { name: "çƒŸå°", lat: 37.4638, lng: 121.4478, displayLat: 43, displayLng: 126, unlockLevel: 20, unlockCost: 5000000 },
                { name: "å¤©æ´¥", lat: 39.3434, lng: 117.3616, displayLat: 46, displayLng: 118, unlockLevel: 22, unlockCost: 6000000 },
                { name: "çŸ³å®¶åº„", lat: 38.0428, lng: 114.5149, displayLat: 44, displayLng: 114, unlockLevel: 22, unlockCost: 6000000 },
                { name: "åŒ—äº¬", lat: 39.9042, lng: 116.4074, displayLat: 48, displayLng: 116, unlockLevel: 25, unlockCost: 8000000 },
                { name: "å¤ªåŸ", lat: 37.8706, lng: 112.5489, displayLat: 42, displayLng: 108, unlockLevel: 25, unlockCost: 8000000 },
                { name: "æ²ˆé˜³", lat: 41.8057, lng: 123.4315, displayLat: 50, displayLng: 128, unlockLevel: 28, unlockCost: 10000000 },
                { name: "å¤§è¿", lat: 38.9140, lng: 121.6147, displayLat: 47, displayLng: 124, unlockLevel: 28, unlockCost: 10000000 },
                { name: "é•¿æ˜¥", lat: 43.8171, lng: 125.3235, displayLat: 52, displayLng: 130, unlockLevel: 30, unlockCost: 12000000 },
                { name: "å“ˆå°”æ»¨", lat: 45.8038, lng: 126.5350, displayLat: 54, displayLng: 134, unlockLevel: 30, unlockCost: 12000000 },
                { name: "è¥¿å®‰", lat: 34.3416, lng: 108.9398, displayLat: 38, displayLng: 100, unlockLevel: 32, unlockCost: 15000000 },
                { name: "è¥„é˜³", lat: 32.0091, lng: 112.1226, displayLat: 37, displayLng: 106, unlockLevel: 32, unlockCost: 15000000 },
                { name: "æˆéƒ½", lat: 30.5728, lng: 104.0668, displayLat: 34, displayLng: 90, unlockLevel: 35, unlockCost: 20000000 },
                { name: "é‡åº†", lat: 29.4316, lng: 106.9123, displayLat: 33, displayLng: 94, unlockLevel: 35, unlockCost: 20000000 },
                { name: "è´µé˜³", lat: 26.6470, lng: 106.6302, displayLat: 28, displayLng: 92, unlockLevel: 38, unlockCost: 25000000 },
                { name: "æ˜†æ˜", lat: 25.0389, lng: 102.7183, displayLat: 26, displayLng: 86, unlockLevel: 38, unlockCost: 25000000 },
                { name: "å…°å·", lat: 36.0611, lng: 103.8343, displayLat: 40, displayLng: 88, unlockLevel: 40, unlockCost: 30000000 },
                { name: "è¥¿å®", lat: 36.6171, lng: 101.7782, displayLat: 41, displayLng: 84, unlockLevel: 40, unlockCost: 30000000 },
                { name: "é“¶å·", lat: 38.4872, lng: 106.2309, displayLat: 43, displayLng: 94, unlockLevel: 42, unlockCost: 35000000 },
                { name: "å‘¼å’Œæµ©ç‰¹", lat: 40.8414, lng: 111.7519, displayLat: 46, displayLng: 104, unlockLevel: 42, unlockCost: 35000000 },
                { name: "ä¹Œé²æœ¨é½", lat: 43.8256, lng: 87.6168, displayLat: 48, displayLng: 72, unlockLevel: 45, unlockCost: 50000000 },
                { name: "æ‹‰è¨", lat: 29.6500, lng: 91.1000, displayLat: 32, displayLng: 78, unlockLevel: 50, unlockCost: 80000000 }
            ],
            world: [
                // ä¸­å›½åŸå¸‚
                { name: "å¹¿å·", lat: 23.1291, lng: 113.2644, unlockLevel: 1, unlockCost: 0 },
                { name: "æ·±åœ³", lat: 22.5431, lng: 114.0579, unlockLevel: 1, unlockCost: 0 },
                { name: "ä¸œè", lat: 23.0207, lng: 113.7518, unlockLevel: 3, unlockCost: 100000 },
                { name: "ä½›å±±", lat: 23.0218, lng: 113.1219, unlockLevel: 4, unlockCost: 150000 },
                { name: "ç æµ·", lat: 22.2707, lng: 113.5767, unlockLevel: 5, unlockCost: 200000 },
                { name: "æ­¦æ±‰", lat: 30.5928, lng: 114.3055, unlockLevel: 10, unlockCost: 800000 },
                { name: "æ­å·", lat: 30.2741, lng: 120.1551, unlockLevel: 13, unlockCost: 1500000 },
                { name: "ä¸Šæµ·", lat: 31.2304, lng: 121.4737, unlockLevel: 16, unlockCost: 2500000 },
                { name: "å—äº¬", lat: 32.0603, lng: 118.7969, unlockLevel: 18, unlockCost: 3500000 },
                { name: "åŒ—äº¬", lat: 39.9042, lng: 116.4074, unlockLevel: 25, unlockCost: 8000000 },
                { name: "æˆéƒ½", lat: 30.5728, lng: 104.0668, unlockLevel: 35, unlockCost: 20000000 },
                { name: "é‡åº†", lat: 29.4316, lng: 106.9123, unlockLevel: 35, unlockCost: 20000000 },
                { name: "è¥¿å®‰", lat: 34.3416, lng: 108.9398, unlockLevel: 32, unlockCost: 15000000 },
                { name: "ä¹Œé²æœ¨é½", lat: 43.8256, lng: 87.6168, unlockLevel: 45, unlockCost: 50000000 },
                { name: "æ‹‰è¨", lat: 29.6500, lng: 91.1000, unlockLevel: 50, unlockCost: 80000000 },
                // å°æ¹¾çœåŸå¸‚
                { name: "å°åŒ—", lat: 25.0330, lng: 121.5654, unlockLevel: 18, unlockCost: 3500000 },
                { name: "é«˜é›„", lat: 22.6273, lng: 120.3014, unlockLevel: 20, unlockCost: 5000000 },
                { name: "å°ä¸­", lat: 24.1477, lng: 120.6736, unlockLevel: 22, unlockCost: 6000000 },
                { name: "å°å—", lat: 22.9999, lng: 120.2269, unlockLevel: 25, unlockCost: 8000000 },
                // äºšæ´²å…¶ä»–åŸå¸‚
                { name: "ä¸œäº¬", lat: 35.6762, lng: 139.6503, unlockLevel: 20, unlockCost: 5000000 },
                { name: "é¦–å°”", lat: 37.5665, lng: 126.9780, unlockLevel: 22, unlockCost: 6000000 },
                { name: "æ–°åŠ å¡", lat: 1.3521, lng: 103.8198, unlockLevel: 25, unlockCost: 8000000 },
                { name: "æ›¼è°·", lat: 13.7563, lng: 100.5018, unlockLevel: 25, unlockCost: 8000000 },
                { name: "å‰éš†å¡", lat: 3.1390, lng: 101.6869, unlockLevel: 28, unlockCost: 10000000 },
                { name: "é›…åŠ è¾¾", lat: -6.2088, lng: 106.8456, unlockLevel: 28, unlockCost: 10000000 },
                { name: "é©¬å°¼æ‹‰", lat: 14.5995, lng: 120.9842, unlockLevel: 30, unlockCost: 12000000 },
                { name: "æ²³å†…", lat: 21.0285, lng: 105.8542, unlockLevel: 30, unlockCost: 12000000 },
                { name: "èƒ¡å¿—æ˜å¸‚", lat: 10.8231, lng: 106.6297, unlockLevel: 32, unlockCost: 15000000 },
                { name: "ä»°å…‰", lat: 16.8661, lng: 96.1951, unlockLevel: 32, unlockCost: 15000000 },
                { name: "é‡‘è¾¹", lat: 11.5564, lng: 104.9282, unlockLevel: 35, unlockCost: 20000000 },
                { name: "ä¸‡è±¡", lat: 17.9757, lng: 102.6331, unlockLevel: 35, unlockCost: 20000000 },
                { name: "æ–°å¾·é‡Œ", lat: 28.6139, lng: 77.2090, unlockLevel: 38, unlockCost: 25000000 },
                { name: "å­Ÿä¹°", lat: 19.0760, lng: 72.8777, unlockLevel: 38, unlockCost: 25000000 },
                { name: "åŠ å°”å„ç­”", lat: 22.5726, lng: 88.3639, unlockLevel: 40, unlockCost: 30000000 },
                { name: "ç­åŠ ç½—å°”", lat: 12.9716, lng: 77.5946, unlockLevel: 40, unlockCost: 30000000 },
                // ä¸­ä¸œ
                { name: "è¿ªæ‹œ", lat: 25.2048, lng: 55.2708, unlockLevel: 42, unlockCost: 35000000 },
                { name: "é˜¿å¸ƒæ‰æ¯”", lat: 24.4539, lng: 54.3773, unlockLevel: 42, unlockCost: 35000000 },
                { name: "åˆ©é›…å¾—", lat: 24.7136, lng: 46.6753, unlockLevel: 45, unlockCost: 50000000 },
                { name: "å¤šå“ˆ", lat: 25.2854, lng: 51.5310, unlockLevel: 45, unlockCost: 50000000 },
                // æ¬§æ´²
                { name: "ä¼Šæ–¯å¦å¸ƒå°”", lat: 41.0082, lng: 28.9784, unlockLevel: 48, unlockCost: 60000000 },
                { name: "å¼€ç½—", lat: 30.0444, lng: 31.2357, unlockLevel: 50, unlockCost: 80000000 },
                { name: "ä¼¦æ•¦", lat: 51.5074, lng: -0.1278, unlockLevel: 55, unlockCost: 100000000 },
                { name: "å·´é»", lat: 48.8566, lng: 2.3522, unlockLevel: 55, unlockCost: 100000000 },
                { name: "æŸæ—", lat: 52.5200, lng: 13.4050, unlockLevel: 58, unlockCost: 120000000 },
                { name: "ç½—é©¬", lat: 41.9028, lng: 12.4964, unlockLevel: 58, unlockCost: 120000000 },
                { name: "é©¬å¾·é‡Œ", lat: 40.4168, lng: -3.7038, unlockLevel: 60, unlockCost: 150000000 },
                // ç¾æ´²å’Œå¤§æ´‹æ´²
                { name: "çº½çº¦", lat: 40.7128, lng: -74.0060, unlockLevel: 65, unlockCost: 200000000 },
                { name: "æ´›æ‰çŸ¶", lat: 34.0522, lng: -118.2437, unlockLevel: 65, unlockCost: 200000000 },
                { name: "æ‚‰å°¼", lat: -33.8688, lng: 151.2093, unlockLevel: 70, unlockCost: 300000000 }
            ]
        };

        // ==================== ç«è½¦æ•°æ® ====================
        const trainTypes = {
            normal: { name: "æ™®é€šç«è½¦", color: "#00d4ff" },
            intercity: { name: "åŸé™…åˆ—è½¦", color: "#00ff88" },
            highspeed: { name: "é«˜é“", color: "#ff3366" },
            anime: { name: "åŠ¨æ¼«è”å", color: "#ff00ff" },
            zodiac: { name: "ç”Ÿè‚–é™å®š", color: "#ff6b00" }
        };

        const trainData = {
            normal: [
                { name: "å’Œè°å·", speed: 80, weight: 600, price: 5000, level: 1, comfort: 100 },
                { name: "å¤å…´å·", speed: 88, weight: 580, price: 12000, level: 2, comfort: 150 },
                { name: "è§£æ”¾å·", speed: 96, weight: 560, price: 22000, level: 3, comfort: 200 },
                { name: "å‰è¿›å·", speed: 104, weight: 540, price: 35000, level: 4, comfort: 250 },
                { name: "å»ºè®¾å·", speed: 112, weight: 520, price: 50000, level: 5, comfort: 300 },
                { name: "ä¸œé£å·", speed: 120, weight: 500, price: 70000, level: 6, comfort: 350 },
                { name: "éŸ¶å±±å·", speed: 128, weight: 480, price: 95000, level: 7, comfort: 400 },
                { name: "åŒ—äº¬å·", speed: 136, weight: 460, price: 125000, level: 8, comfort: 450 },
                { name: "ä¸Šæµ·å·", speed: 144, weight: 440, price: 160000, level: 9, comfort: 500 },
                { name: "å¹¿å·å·", speed: 152, weight: 420, price: 200000, level: 10, comfort: 550 },
                { name: "æ·±åœ³å·", speed: 160, weight: 400, price: 250000, level: 12, comfort: 650 },
                { name: "æˆéƒ½å·", speed: 168, weight: 380, price: 300000, level: 14, comfort: 750 },
                { name: "é‡åº†å·", speed: 176, weight: 360, price: 350000, level: 16, comfort: 850 },
                { name: "æ­å·å·", speed: 184, weight: 340, price: 400000, level: 18, comfort: 950 },
                { name: "æ­¦æ±‰å·", speed: 192, weight: 320, price: 440000, level: 20, comfort: 1050 },
                { name: "è¥¿å®‰å·", speed: 200, weight: 300, price: 470000, level: 22, comfort: 1150 },
                { name: "å—äº¬å·", speed: 208, weight: 280, price: 485000, level: 24, comfort: 1250 },
                { name: "å¤©æ´¥å·", speed: 216, weight: 260, price: 495000, level: 26, comfort: 1350 },
                { name: "è‹å·å·", speed: 224, weight: 240, price: 498000, level: 28, comfort: 1450 },
                { name: "éƒ‘å·å·", speed: 235, weight: 220, price: 500000, level: 30, comfort: 1550 }
            ],
            intercity: [
                { name: "åŸé™…å¿«çº¿1å·", speed: 250, weight: 400, price: 1000000, level: 15, comfort: 1600 },
                { name: "åŸé™…å¿«çº¿2å·", speed: 265, weight: 390, price: 1500000, level: 17, comfort: 1750 },
                { name: "åŸé™…å¿«çº¿3å·", speed: 280, weight: 380, price: 2100000, level: 19, comfort: 1900 },
                { name: "åŸé™…å¿«çº¿4å·", speed: 295, weight: 370, price: 2800000, level: 21, comfort: 2050 },
                { name: "åŸé™…å¿«çº¿5å·", speed: 310, weight: 360, price: 3600000, level: 23, comfort: 2200 },
                { name: "åŸé™…å¿«çº¿6å·", speed: 325, weight: 350, price: 4500000, level: 25, comfort: 2350 },
                { name: "åŸé™…å¿«çº¿7å·", speed: 340, weight: 340, price: 5500000, level: 27, comfort: 2500 },
                { name: "åŸé™…å¿«çº¿8å·", speed: 355, weight: 330, price: 6600000, level: 29, comfort: 2650 },
                { name: "åŸé™…å¿«çº¿9å·", speed: 370, weight: 320, price: 7800000, level: 31, comfort: 2800 },
                { name: "åŸé™…å¿«çº¿10å·", speed: 385, weight: 310, price: 9100000, level: 33, comfort: 2950 },
                { name: "åŸé™…å¿«çº¿11å·", speed: 400, weight: 300, price: 10500000, level: 35, comfort: 3100 },
                { name: "åŸé™…å¿«çº¿12å·", speed: 415, weight: 290, price: 12000000, level: 37, comfort: 3250 },
                { name: "åŸé™…å¿«çº¿13å·", speed: 430, weight: 280, price: 13600000, level: 39, comfort: 3400 },
                { name: "åŸé™…å¿«çº¿14å·", speed: 445, weight: 270, price: 15300000, level: 41, comfort: 3550 },
                { name: "åŸé™…å¿«çº¿15å·", speed: 465, weight: 260, price: 20000000, level: 43, comfort: 3700 }
            ],
            highspeed: [
                { name: "äº¬æ²ªé«˜é“1å·", speed: 480, weight: 320, price: 60000000, level: 32, comfort: 3850 },
                { name: "äº¬æ²ªé«˜é“2å·", speed: 500, weight: 310, price: 80000000, level: 34, comfort: 4000 },
                { name: "äº¬æ²ªé«˜é“3å·", speed: 520, weight: 300, price: 105000000, level: 36, comfort: 4150 },
                { name: "äº¬æ²ªé«˜é“4å·", speed: 540, weight: 290, price: 135000000, level: 38, comfort: 4300 },
                { name: "äº¬æ²ªé«˜é“5å·", speed: 560, weight: 280, price: 170000000, level: 40, comfort: 4450 },
                { name: "äº¬å¹¿é«˜é“1å·", speed: 580, weight: 270, price: 210000000, level: 42, comfort: 4600 },
                { name: "äº¬å¹¿é«˜é“2å·", speed: 600, weight: 260, price: 255000000, level: 44, comfort: 4750 },
                { name: "äº¬å¹¿é«˜é“3å·", speed: 620, weight: 250, price: 305000000, level: 46, comfort: 4900 },
                { name: "æ²ªæ˜†é«˜é“1å·", speed: 640, weight: 240, price: 360000000, level: 48, comfort: 5050 },
                { name: "æ²ªæ˜†é«˜é“2å·", speed: 660, weight: 230, price: 420000000, level: 50, comfort: 5200 },
                { name: "æ²ªæ˜†é«˜é“3å·", speed: 680, weight: 220, price: 490000000, level: 52, comfort: 5350 },
                { name: "å“ˆå¤§é«˜é“1å·", speed: 700, weight: 210, price: 570000000, level: 54, comfort: 5500 },
                { name: "å“ˆå¤§é«˜é“2å·", speed: 720, weight: 200, price: 660000000, level: 56, comfort: 5650 },
                { name: "è¥¿æˆé«˜é“1å·", speed: 740, weight: 190, price: 760000000, level: 58, comfort: 5800 },
                { name: "è¥¿æˆé«˜é“2å·", speed: 770, weight: 180, price: 900000000, level: 60, comfort: 5950 }
            ],
            anime: [
                { name: "é¾™çŒ«å·", speed: 780, weight: 280, price: 3600000000, level: 20, comfort: 6100 },
                { name: "åƒå¯»å·", speed: 800, weight: 270, price: 4200000000, level: 22, comfort: 6250 },
                { name: "å“ˆå°”å·", speed: 820, weight: 260, price: 4900000000, level: 24, comfort: 6400 },
                { name: "å¤©ç©ºä¹‹åŸå·", speed: 840, weight: 250, price: 5700000000, level: 26, comfort: 6550 },
                { name: "é£ä¹‹è°·å·", speed: 860, weight: 240, price: 6600000000, level: 28, comfort: 6700 },
                { name: "ç«å½±å¿è€…å·", speed: 880, weight: 230, price: 7600000000, level: 30, comfort: 6850 },
                { name: "æµ·è´¼ç‹å·", speed: 900, weight: 220, price: 8700000000, level: 32, comfort: 7000 },
                { name: "æŸ¯å—å·", speed: 920, weight: 210, price: 9900000000, level: 34, comfort: 7150 },
                { name: "å“†å•¦Aæ¢¦å·", speed: 940, weight: 200, price: 11200000000, level: 36, comfort: 7300 },
                { name: "ç²¾çµå®å¯æ¢¦å·", speed: 960, weight: 190, price: 12600000000, level: 38, comfort: 7450 },
                { name: "æ•°ç å®è´å·", speed: 980, weight: 180, price: 14100000000, level: 40, comfort: 7600 },
                { name: "åœ£æ–—å£«å·", speed: 1000, weight: 170, price: 15700000000, level: 42, comfort: 7750 },
                { name: "çŒç¯®é«˜æ‰‹å·", speed: 1020, weight: 160, price: 17400000000, level: 44, comfort: 7900 },
                { name: "æ–°ä¸–çºªç¦éŸ³å·", speed: 1040, weight: 150, price: 19200000000, level: 46, comfort: 8050 },
                { name: "è¿›å‡»çš„å·¨äººå·", speed: 1070, weight: 140, price: 22000000000, level: 48, comfort: 8200 }
            ],
            zodiac: [
                { name: "é¼ å¹´çºªå¿µå·", speed: 1080, weight: 200, price: 110000000000, level: 47, comfort: 8350 },
                { name: "ç‰›å¹´çºªå¿µå·", speed: 1100, weight: 195, price: 125000000000, level: 49, comfort: 8500 },
                { name: "è™å¹´çºªå¿µå·", speed: 1120, weight: 190, price: 142000000000, level: 50, comfort: 8650 },
                { name: "å…”å¹´çºªå¿µå·", speed: 1140, weight: 185, price: 160000000000, level: 51, comfort: 8800 },
                { name: "é¾™å¹´çºªå¿µå·", speed: 1160, weight: 180, price: 180000000000, level: 52, comfort: 8950 },
                { name: "è›‡å¹´çºªå¿µå·", speed: 1180, weight: 175, price: 200000000000, level: 53, comfort: 9100 },
                { name: "é©¬å¹´çºªå¿µå·", speed: 1200, weight: 170, price: 222000000000, level: 54, comfort: 9250 },
                { name: "ç¾Šå¹´çºªå¿µå·", speed: 1220, weight: 165, price: 245000000000, level: 55, comfort: 9400 },
                { name: "çŒ´å¹´çºªå¿µå·", speed: 1240, weight: 160, price: 270000000000, level: 56, comfort: 9550 },
                { name: "é¸¡å¹´çºªå¿µå·", speed: 1260, weight: 155, price: 296000000000, level: 57, comfort: 9700 },
                { name: "ç‹—å¹´çºªå¿µå·", speed: 1280, weight: 150, price: 324000000000, level: 58, comfort: 9850 },
                { name: "çŒªå¹´çºªå¿µå·", speed: 1300, weight: 145, price: 353000000000, level: 59, comfort: 10000 },
                { name: "é‡‘é¾™å·", speed: 1320, weight: 140, price: 384000000000, level: 60, comfort: 10150 },
                { name: "é“¶é¾™å·", speed: 1340, weight: 135, price: 416000000000, level: 61, comfort: 10300 },
                { name: "ç¥¥é¾™å·", speed: 1360, weight: 130, price: 450000000000, level: 62, comfort: 10450 },
                { name: "ç‘é¾™å·", speed: 1380, weight: 125, price: 486000000000, level: 63, comfort: 10600 },
                { name: "ç¦é¾™å·", speed: 1400, weight: 120, price: 524000000000, level: 64, comfort: 10750 },
                { name: "å–œé¾™å·", speed: 1420, weight: 115, price: 564000000000, level: 65, comfort: 10900 },
                { name: "è´¢é¾™å·", speed: 1440, weight: 110, price: 606000000000, level: 66, comfort: 11050 },
                { name: "è¿é¾™å·", speed: 1500, weight: 100, price: 700000000000, level: 66, comfort: 11200 },
                { name: "é”…å·´å·", speed: 1550, weight: 95, price: 850000000000, level: 66, comfort: 11400 },
                { name: "æ ‘å¶å·", speed: 1600, weight: 90, price: 1000000000000, level: 66, comfort: 11600 },
                { name: "gitå·", speed: 1800, weight: 70, price: 1500000000000, level: 66, comfort: 11800 },
                { name: "é¡¶çº§èŒæ–°å·", speed: 2000, weight: 50, price: 2000000000000, level: 66, comfort: 12000 }
            ]
        };

        const employeeTypes = {
            income: { name: "æ”¶ç›Šå‹", color: "#00ff88", effect: "å¢åŠ æ”¶ç›Š", baseBonus: 5 },
            speed: { name: "é€Ÿåº¦å‹", color: "#00d4ff", effect: "æé«˜é€Ÿåº¦", baseBonus: 5 },
            weight: { name: "å‡é‡å‹", color: "#ff3366", effect: "é™ä½é‡é‡", baseBonus: 3 }
        };

        const weatherTypes = {
            heavyRain: { name: "æš´é›¨", icon: "ğŸŒ§ï¸", speedMod: -0.30, incomeMod: 0, color: "#4a90d9", desc: "é€Ÿåº¦-30%" },
            moderateRain: { name: "ä¸­é›¨", icon: "ğŸŒ§ï¸", speedMod: -0.15, incomeMod: 0, color: "#6aa8e8", desc: "é€Ÿåº¦-15%" },
            lightRain: { name: "å°é›¨", icon: "ğŸŒ¦ï¸", speedMod: -0.05, incomeMod: 0, color: "#8ac0f0", desc: "é€Ÿåº¦-5%" },
            cloudy: { name: "å¤šäº‘", icon: "â›…", speedMod: 0, incomeMod: 0, color: "#a0a0a0", desc: "æ— æ•ˆæœ" },
            sunny: { name: "æ™´å¤©", icon: "â˜€ï¸", speedMod: 0, incomeMod: 0.10, color: "#ffd700", desc: "åˆ©æ¶¦+10%" },
            hot: { name: "é«˜æ¸©", icon: "ğŸŒ¡ï¸", speedMod: 0, incomeMod: -0.05, color: "#ff6b35", desc: "åˆ©æ¶¦-5%" },
            extremeHot: { name: "è¶…é«˜æ¸©", icon: "ğŸ”¥", speedMod: 0, incomeMod: -0.20, color: "#ff3300", desc: "åˆ©æ¶¦-20%" },
            fog: { name: "å¤§é›¾", icon: "ğŸŒ«ï¸", speedMod: -0.05, incomeMod: -0.05, color: "#c0c0c0", desc: "é€Ÿåº¦-5%ï¼Œåˆ©æ¶¦-5%" },
            heavySnow: { name: "å¤§é›ª", icon: "â„ï¸", speedMod: -0.15, incomeMod: -0.15, color: "#e0f0ff", desc: "é€Ÿåº¦-15%ï¼Œåˆ©æ¶¦-15%" },
            sandstorm: { name: "æ²™å°˜æš´", icon: "ğŸŒªï¸", speedMod: -0.50, incomeMod: 0, color: "#d4a574", desc: "é€Ÿåº¦-50%" },
            carnival: { name: "ç‹‚æ¬¢", icon: "ğŸ‰", speedMod: 0.30, incomeMod: 0.30, color: "#ff00ff", desc: "é€Ÿåº¦+30%ï¼Œåˆ©æ¶¦+30%" }
        };

        const weatherWeights = {
            heavyRain: 5, moderateRain: 8, lightRain: 10, cloudy: 20,
            sunny: 25, hot: 12, extremeHot: 5, fog: 8, heavySnow: 5, sandstorm: 2, carnival: 3
        };

        const employeeNames = ["å¼ ä¼Ÿ", "ç‹èŠ³", "ææ˜", "åˆ˜æ´‹", "é™ˆé™", "æ¨å¸†", "èµµç£Š", "é»„ä¸½", "å‘¨æ°", "å´æ•", "å¾å¼º", "å­™å©·", "é©¬è¶…", "æœ±çº¢", "èƒ¡å†›", "éƒ­ç‡•", "æ—å³°", "ä½•é›ª", "é«˜è¿œ", "ç½—ç³", "æ¢æ¶›", "å®‹é›¨", "éƒ‘å", "è°¢é¹", "éŸ©å†°", "å”äº®", "å†¯å¨œ", "è‘£å¼º", "è§ç„¶", "ç¨‹é™"];

        const redeemCodes = {
            "shuye": { points: 3000, used: false },
            "maniandaji": { points: 6000, used: false },
            "vip666": { points: 0, reformStones: 300, used: false },
            "914181599": { points: 3000, reformStones: 288, used: false },
            "é¡¶çº§èŒæ–°": { points: 5000, reformStones: 388, used: false },
            "guoba": { points: 2000, reformStones: 288, used: false },
            "gityx": { train: "é©¬å¹´çºªå¿µå·", used: false }
        };

        // ==================== æ¸¸æˆçŠ¶æ€ ====================
        let gameState = {
            gold: 20000, points: 0, level: 1, exp: 0, expToNext: 500,
            employees: [], runningTrains: [], ownedTrains: [],
            unlockedCities: ["å¹¿å·", "æ·±åœ³"], dailyPointsEarned: 0,
            lastDailyReset: null, lastSaveTime: null, lastOnlineTime: null,
            totalEarnings: 0, incomeBonus: 0, consumedPoints: 0,
            usedRedeemCodes: [],
            // æ”¹é€ çŸ³ç³»ç»Ÿ
            reformStones: 0,           // å½“å‰æ”¹é€ çŸ³æ•°é‡
            dailyReformStonesEarned: 0, // ä»Šæ—¥å·²è·å–çš„æ”¹é€ çŸ³æ•°é‡
            // å¤©æ°”ç³»ç»Ÿ
            currentWeather: 'sunny',    // å½“å‰å¤©æ°”
            lastWeatherUpdate: null     // ä¸Šæ¬¡å¤©æ°”æ›´æ–°æ—¶é—´
        };

        let selectedStartCity = null, selectedEndCity = null, currentCityTab = 'china', currentShopTab = 'normal', pendingUnlockCity = null;

        // ==================== å·¥å…·å‡½æ•° ====================
        function calculateDistance(city1, city2) {
            const R = 6371;
            const dLat = (city2.lat - city1.lat) * Math.PI / 180;
            const dLng = (city2.lng - city1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(city1.lat * Math.PI / 180) * Math.cos(city2.lat * Math.PI / 180) * Math.sin(dLng/2) * Math.sin(dLng/2);
            return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function getCityByName(name) {
            return cities.china.find(c => c.name === name) || cities.world.find(c => c.name === name);
        }

        function isCityUnlocked(cityName) { return gameState.unlockedCities.includes(cityName); }

        function calculateEarnings(train, distance) {
            let earnings = distance * 10 * (1 - train.weight / 10000);
            gameState.employees.filter(e => e.trainId === train.id).forEach(emp => {
                if (emp.type === 'income') earnings *= (1 + employeeTypes.income.baseBonus * emp.level / 100);
            });
            earnings *= (1 + gameState.incomeBonus / 100);
            if (train.upgradeLevel) earnings *= (1 + train.upgradeLevel * 0.5 / 100);
            const comfort = train.comfort || 100;
            const comfortBonus = comfort / 100;
            earnings *= (1 + comfortBonus / 100);
            const weatherIncomeMod = getWeatherIncomeModifier();
            earnings *= (1 + weatherIncomeMod);
            return Math.round(earnings);
        }

        function calculateTime(train, distance) {
            let speed = train.speed;
            const reformLevel = train.reformLevel || 0;
            speed *= (1 + reformLevel * 0.01);
            gameState.employees.filter(e => e.trainId === train.id).forEach(emp => {
                if (emp.type === 'speed') speed *= (1 + employeeTypes.speed.baseBonus * emp.level / 100);
            });
            const weatherSpeedMod = getWeatherSpeedModifier();
            speed *= (1 + weatherSpeedMod);
            return Math.max(5, Math.round(20 * distance / speed));
        }

        function calculateWeight(train) {
            let weight = train.weight;
            gameState.employees.filter(e => e.trainId === train.id).forEach(emp => {
                if (emp.type === 'weight') weight *= (1 - employeeTypes.weight.baseBonus * emp.level / 100);
            });
            return Math.round(weight);
        }

        function calculateUpgradeCost(level) { return level * level * 3; }
        function calculateTrainUpgradeCost(level) { return level * 20; }
        function calculateTotalUpgradeCost(currentLevel) {
            let total = 0;
            for (let i = 1; i < currentLevel; i++) {
                total += calculateUpgradeCost(i);
            }
            return total;
        }
        function calculateTotalTrainUpgradeCost(currentLevel) {
            let total = 0;
            for (let i = 1; i <= currentLevel; i++) {
                total += calculateTrainUpgradeCost(i);
            }
            return total;
        }
        function calculateTotalReformStones(reformLevel) {
            let total = 0;
            for (let i = 1; i <= reformLevel; i++) {
                total += i * 5;
            }
            return total;
        }
        function calculateExpToNext(level) { return Math.floor(500 * Math.pow(1.8, level - 1)); }

        function addExp(amount) {
            gameState.exp += amount;
            while (gameState.exp >= gameState.expToNext) {
                gameState.exp -= gameState.expToNext;
                gameState.level++;
                gameState.expToNext = calculateExpToNext(gameState.level);
                showNotification(`æ­å–œå‡çº§ï¼å½“å‰ç­‰çº§: ${gameState.level}`);
            }
            updateLevelUI();
        }

        function getBeijingTime() {
            const now = new Date();
            return new Date(now.getTime() + (now.getTimezoneOffset() + 480) * 60000);
        }

        function checkDailyPointsReset() {
            const beijingTime = getBeijingTime();
            const today8AM = new Date(beijingTime); today8AM.setHours(8, 0, 0, 0);
            if (!gameState.lastDailyReset || new Date(gameState.lastDailyReset) < today8AM) {
                if (beijingTime >= today8AM) {
                    gameState.dailyPointsEarned = 0;
                    gameState.dailyReformStonesEarned = 0; // æ”¹é€ çŸ³æ¯æ—¥ä¸Šé™é‡ç½®
                    gameState.lastDailyReset = beijingTime.toISOString();
                }
            }
        }

        // ==================== å¤©æ°”ç³»ç»Ÿ ====================
        const WEATHER_INTERVAL = 4 * 60 * 60 * 1000; // 4å°æ—¶ï¼ˆæ¯«ç§’ï¼‰

        function getRandomWeather() {
            const totalWeight = Object.values(weatherWeights).reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            for (const [weather, weight] of Object.entries(weatherWeights)) {
                random -= weight;
                if (random <= 0) return weather;
            }
            return 'sunny';
        }

        function updateWeather() {
            const now = Date.now();
            if (!gameState.lastWeatherUpdate) {
                gameState.lastWeatherUpdate = now;
                gameState.currentWeather = getRandomWeather();
            }
            const timeSinceLastUpdate = now - gameState.lastWeatherUpdate;
            if (timeSinceLastUpdate >= WEATHER_INTERVAL) {
                const oldWeather = gameState.currentWeather;
                gameState.currentWeather = getRandomWeather();
                gameState.lastWeatherUpdate = now;
                const weatherInfo = weatherTypes[gameState.currentWeather];
                showNotification(`å¤©æ°”å˜åŒ–ï¼š${weatherInfo.icon} ${weatherInfo.name} - ${weatherInfo.desc}`);
                updateWeatherUI();
                updateRunningTrainsForWeather();
            }
        }

        function updateRunningTrainsForWeather() {
            const weather = weatherTypes[gameState.currentWeather];
            gameState.runningTrains.forEach(rt => {
                const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
                if (train) {
                    const baseSpeed = train.speed * (1 + (train.reformLevel || 0) * 0.01);
                    const weatherSpeed = baseSpeed * (1 + weather.speedMod);
                    const distance = calculateDistance(getCityByName(rt.startCity), getCityByName(rt.endCity));
                    const newTotalTime = distance / weatherSpeed * 3600;
                    const progress = (rt.totalTime - rt.remainingTime) / rt.totalTime;
                    rt.totalTime = newTotalTime;
                    rt.remainingTime = newTotalTime * (1 - progress);
                }
            });
        }

        function getWeatherSpeedModifier() {
            return weatherTypes[gameState.currentWeather].speedMod;
        }

        function getWeatherIncomeModifier() {
            return weatherTypes[gameState.currentWeather].incomeMod;
        }

        function updateWeatherUI() {
            const weather = weatherTypes[gameState.currentWeather];
            const weatherInfoEl = document.getElementById('weatherInfo');
            const weatherEffectEl = document.getElementById('weatherEffect');
            const weatherTimerEl = document.getElementById('weatherTimer');
            if (weatherInfoEl) {
                weatherInfoEl.innerHTML = `<span style="color:${weather.color};">${weather.icon} ${weather.name}</span>`;
            }
            if (weatherEffectEl) {
                let effects = [];
                if (weather.speedMod !== 0) {
                    effects.push(`é€Ÿåº¦${weather.speedMod > 0 ? '+' : ''}${(weather.speedMod * 100).toFixed(0)}%`);
                }
                if (weather.incomeMod !== 0) {
                    effects.push(`åˆ©æ¶¦${weather.incomeMod > 0 ? '+' : ''}${(weather.incomeMod * 100).toFixed(0)}%`);
                }
                if (effects.length === 0) {
                    effects.push('æ— æ•ˆæœ');
                }
                weatherEffectEl.textContent = effects.join(' | ');
            }
            if (weatherTimerEl) {
                const remaining = getWeatherRemainingTime();
                weatherTimerEl.textContent = `ä¸‹æ¬¡åˆ·æ–°: ${formatWeatherTime(remaining)}`;
            }
        }

        function getWeatherRemainingTime() {
            if (!gameState.lastWeatherUpdate) return 0;
            const elapsed = Date.now() - gameState.lastWeatherUpdate;
            return Math.max(0, WEATHER_INTERVAL - elapsed);
        }

        function formatWeatherTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${hours}æ—¶${minutes}åˆ†${seconds}ç§’`;
        }

        // ==================== ç•Œé¢æ¸²æŸ“ ====================
        function updateUI() {
            document.getElementById('gold').textContent = formatNumber(gameState.gold);
            document.getElementById('points').textContent = formatNumber(gameState.points);
            document.getElementById('runningCount').textContent = gameState.runningTrains.length;
            document.getElementById('incomeBonus').textContent = `+${gameState.incomeBonus}%`;
            checkDailyPointsReset();
            document.getElementById('dailyPointsInfo').textContent = `ä»Šæ—¥ç‚¹å·: ${gameState.dailyPointsEarned}/1500`;
            updateWeather();
            updateWeatherUI();
        }

        function updateLevelUI() {
            document.getElementById('playerLevel').textContent = gameState.level;
            document.getElementById('sidebarLevel').textContent = gameState.level;
            document.getElementById('expBar').style.width = `${(gameState.exp / gameState.expToNext) * 100}%`;
            document.getElementById('expText').textContent = `${formatNumber(gameState.exp)} / ${formatNumber(gameState.expToNext)} XP`;
        }

        function formatNumber(num) {
            if (num >= 100000000) return (num / 100000000).toFixed(2) + 'äº¿';
            if (num >= 10000) return (num / 10000).toFixed(2) + 'ä¸‡';
            return num.toLocaleString();
        }

        function showPanel(panelName) {
            document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
            document.getElementById(panelName + 'Panel').style.display = 'block';
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            const renderFuncs = { trains: renderTrainList, routes: renderRoutePanel, employees: renderEmployeeList, shop: renderShop, running: renderRunningTrains, map: renderMap, cities: renderCityUnlockList, upgrade: renderUpgradePanel, redeem: renderRedeemPanel, reform: renderReformPanel };
            if (renderFuncs[panelName]) renderFuncs[panelName]();
        }

        function showCityTab(tab) {
            currentCityTab = tab;
            document.querySelectorAll('#routesPanel .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('chinaCities').style.display = tab === 'china' ? 'grid' : 'none';
            document.getElementById('worldCities').style.display = tab === 'world' ? 'grid' : 'none';
        }

        function showShopTab(tab) {
            currentShopTab = tab;
            document.querySelectorAll('#shopPanel .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            renderShop();
        }

        function renderTrainList() {
            const container = document.getElementById('trainList');
            // æ›´æ–°å„ç±»å‹ç«è½¦æ•°é‡æ˜¾ç¤º
            const typeLimits = { normal: 20, intercity: 24, highspeed: 28, anime: 33, zodiac: 999 };
            const typeNames = { normal: 'æ™®é€š', intercity: 'åŸé™…', highspeed: 'é«˜é“', anime: 'åŠ¨æ¼«', zodiac: 'ç”Ÿè‚–' };
            const counts = {};
            Object.keys(typeLimits).forEach(type => { counts[type] = gameState.ownedTrains.filter(t => t.type === type).length; });
            const totalCount = gameState.ownedTrains.length;
            const countInfo = Object.keys(typeLimits).map(type => {
                const limit = typeLimits[type] === 999 ? 'âˆ' : typeLimits[type];
                return `${typeNames[type]}:${counts[type]}/${limit}`;
            }).join(' ');
            document.getElementById('trainCountInfo').textContent = `å…±${totalCount}è¾† | ${countInfo}`;
            if (gameState.ownedTrains.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:50px;font-size:13px;">// æš‚æ— ç«è½¦ï¼Œè¯·å‰å¾€å•†åº—è´­ä¹°</div>';
                return;
            }
            container.innerHTML = gameState.ownedTrains.map(train => {
                const typeInfo = trainTypes[train.type];
                const isRunning = gameState.runningTrains.some(rt => rt.trainId === train.id && !rt.paused);
                const upgradeLevel = train.upgradeLevel || 0;
                const reformLevel = train.reformLevel || 0;
                const comfort = train.comfort || 100;
                const comfortBonus = (comfort / 100).toFixed(1);
                const refund = Math.floor(train.purchasePrice * 0.5);
                const refundPoints = calculateTotalTrainUpgradeCost(upgradeLevel);
                const refundStones = calculateTotalReformStones(reformLevel);
                let refundText = `<span style="color:var(--neon-yellow);">${formatNumber(refund)}é‡‘</span>`;
                if (refundPoints > 0) refundText += ` <span style="color:var(--neon-magenta);">${refundPoints}ç‚¹</span>`;
                if (refundStones > 0) refundText += ` <span style="color:var(--neon-cyan);">${refundStones}çŸ³</span>`;
                return `<div class="train-card">
                    <div class="train-name" style="display:flex;justify-content:space-between;align-items:center;">
                        <span>${train.name} ${upgradeLevel > 0 ? `<span class="upgrade-level">+${upgradeLevel}</span>` : ''}</span>
                        <button class="btn btn-secondary btn-small" onclick="renameTrain(${train.id})" style="padding:2px 6px;font-size:10px;">âœï¸</button>
                    </div>
                    <span class="train-type type-${train.type}">${typeInfo.name}</span>
                    ${isRunning ? '<span style="color:var(--neon-green);margin-left:8px;font-size:10px;">â— è¿è¥ä¸­</span>' : ''}
                    <div class="train-stats"><span>âš¡ ${train.speed} km/h</span><span>âš–ï¸ ${train.weight} t</span></div>
                    <div class="train-stats"><span>ğŸ›‹ï¸ ${comfort}</span><span style="color:var(--neon-yellow);">æ”¶å…¥+${comfortBonus}%</span></div>
                    ${upgradeLevel > 0 ? `<div style="font-size:11px;color:var(--neon-magenta);margin-top:8px;">å¼ºåŒ–: Lv.${upgradeLevel}/20 (+${upgradeLevel * 0.5}%)</div>` : ''}
                    ${reformLevel > 0 ? `<div style="font-size:11px;color:var(--neon-cyan);margin-top:4px;">æ”¹é€ : Lv.${reformLevel}/25 (é€Ÿåº¦+${reformLevel}%)</div>` : ''}
                    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:11px;color:var(--fg-secondary);">é€€å½¹è¿”è¿˜: ${refundText}</span>
                        <button class="btn btn-danger btn-small" onclick="retireTrain(${train.id})" ${isRunning ? 'disabled title="è¿è¥ä¸­çš„ç«è½¦æ— æ³•é€€å½¹"' : ''}>é€€å½¹</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renameTrain(trainId) {
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            if (!train) return;
            const newName = prompt('è¯·è¾“å…¥æ–°çš„ç«è½¦åç§°:', train.name);
            if (newName && newName.trim()) {
                train.name = newName.trim();
                renderTrainList();
                showNotification(`ç«è½¦å·²é‡å‘½åä¸º: ${newName.trim()}`);
            }
        }

        function retireTrain(trainId) {
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            if (!train) return;
            if (gameState.runningTrains.some(rt => rt.trainId === trainId && !rt.paused)) {
                showNotification('è¿è¥ä¸­çš„ç«è½¦æ— æ³•é€€å½¹ï¼');
                return;
            }
            const refund = Math.floor(train.purchasePrice * 0.5);
            const upgradeLevel = train.upgradeLevel || 0;
            const reformLevel = train.reformLevel || 0;
            const refundPoints = calculateTotalTrainUpgradeCost(upgradeLevel);
            const refundStones = calculateTotalReformStones(reformLevel);
            gameState.ownedTrains = gameState.ownedTrains.filter(t => t.id !== trainId);
            gameState.runningTrains = gameState.runningTrains.filter(rt => rt.trainId !== trainId);
            gameState.employees.forEach(emp => { if (emp.trainId === trainId) emp.trainId = null; });
            gameState.gold += refund;
            gameState.points += refundPoints;
            gameState.reformStones += refundStones;
            updateUI();
            renderTrainList();
            let refundMsg = [];
            if (refund > 0) refundMsg.push(`${formatNumber(refund)} é‡‘å¸`);
            if (refundPoints > 0) refundMsg.push(`${refundPoints} ç‚¹å·`);
            if (refundStones > 0) refundMsg.push(`${refundStones} æ”¹é€ çŸ³`);
            showNotification(`${train.name} å·²é€€å½¹ï¼Œè¿”è¿˜ ${refundMsg.join('ã€')}ï¼`);
        }

        function renderRoutePanel() {
            const trainSelect = document.getElementById('routeTrainSelect');
            trainSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç«è½¦ --</option>' +
                gameState.ownedTrains.map(t => `<option value="${t.id}">${t.name} ${t.upgradeLevel ? '(+' + t.upgradeLevel + ')' : ''}</option>`).join('');
            
            const startSelect = document.getElementById('startCitySelect');
            // åˆå¹¶åŸå¸‚åˆ—è¡¨å¹¶å»é‡ï¼ˆæ ¹æ®åŸå¸‚åç§°ï¼‰
            const allCities = [...cities.china, ...cities.world];
            const uniqueCities = allCities.filter((city, index, self) => 
                index === self.findIndex(c => c.name === city.name)
            );
            const unlockedCities = uniqueCities.filter(c => isCityUnlocked(c.name));
            startSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©å‡ºå‘åŸå¸‚ --</option>' +
                unlockedCities.map(c => `<option value="${c.name}" ${selectedStartCity?.name === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            
            const endSelect = document.getElementById('endCitySelect');
            endSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©åˆ°è¾¾åŸå¸‚ --</option>' +
                unlockedCities.map(c => `<option value="${c.name}" ${selectedEndCity?.name === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            
            updateRouteInfo();
        }

        function onStartCityChange() {
            const cityName = document.getElementById('startCitySelect').value;
            selectedStartCity = cityName ? getCityByName(cityName) : null;
            updateRouteInfo();
        }

        function onEndCityChange() {
            const cityName = document.getElementById('endCitySelect').value;
            selectedEndCity = cityName ? getCityByName(cityName) : null;
            updateRouteInfo();
        }

        function updateRouteInfo() {
            const trainId = parseFloat(document.getElementById('routeTrainSelect').value);
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            
            if (train && selectedStartCity && selectedEndCity && selectedStartCity.name !== selectedEndCity.name) {
                const distance = calculateDistance(selectedStartCity, selectedEndCity);
                const earnings = calculateEarnings(train, distance);
                const time = calculateTime(train, distance);
                const cost = Math.round(calculateWeight(train) * distance * 0.01);
                const comfort = train.comfort || 100;
                const comfortBonus = (comfort / 100).toFixed(1);
                document.getElementById('routeDistance').textContent = `${distance} KM`;
                document.getElementById('routeEarnings').innerHTML = `é¢„è®¡æ”¶ç›Š: <span style="color:var(--neon-green);">+${formatNumber(earnings)}</span> é‡‘å¸ <span style="color:var(--neon-red);">(-${formatNumber(cost)})</span>`;
                document.getElementById('routeTime').innerHTML = `é¢„è®¡æ—¶é—´: ${time} ç§’ | <span style="color:var(--neon-yellow);">ğŸ›‹ï¸${comfort} (+${comfortBonus}%)</span>`;
                document.getElementById('startRouteBtn').disabled = false;
            } else {
                document.getElementById('routeDistance').textContent = '';
                document.getElementById('routeEarnings').textContent = '';
                document.getElementById('routeTime').textContent = '';
                document.getElementById('startRouteBtn').disabled = true;
            }
        }

        function renderEmployeeList() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹©å‘˜å·¥ --</option>' +
                gameState.employees.map(emp => `<option value="${emp.id}">${emp.name} - ${employeeTypes[emp.type].name} Lv.${emp.level}</option>`).join('');
            document.getElementById('employeeDetail').innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:30px;font-size:12px;">// è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©å‘˜å·¥</div>';
        }

        function showEmployeeDetail() {
            const empId = parseFloat(document.getElementById('employeeSelect').value);
            const container = document.getElementById('employeeDetail');
            if (!empId) {
                container.innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:30px;font-size:12px;">// è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©å‘˜å·¥</div>';
                return;
            }
            const emp = gameState.employees.find(e => e.id === empId);
            const typeInfo = employeeTypes[emp.type];
            const assignedTrain = gameState.ownedTrains.find(t => t.id === emp.trainId);
            const upgradeCost = calculateUpgradeCost(emp.level);
            const canUpgrade = emp.level < 40 && gameState.points >= upgradeCost;
            
            const totalUpgradeCost = calculateTotalUpgradeCost(emp.level);
            container.innerHTML = `<div class="employee-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;"><div><strong style="font-size:16px;">${emp.name}</strong> <span class="employee-type type-${emp.type}">${typeInfo.name}</span></div><div style="color:var(--neon-cyan);font-size:12px;">Lv.${emp.level}/40</div></div>
                <div style="margin:12px 0;"><div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fg-secondary);"><span>${typeInfo.effect}: +${typeInfo.baseBonus * emp.level}%</span><span>${assignedTrain ? 'å·²åˆ†é…: ' + assignedTrain.name : 'æœªåˆ†é…'}</span></div>
                <div class="progress-bar"><div class="progress-fill" style="width:${(emp.level/40)*100}%"></div></div></div>
                <div style="display:flex;gap:10px;">
                    ${emp.level < 40 ? `<button class="btn btn-primary" onclick="upgradeEmployee(${emp.id})" ${canUpgrade ? '' : 'disabled'}>å‡çº§ (${upgradeCost} ç‚¹å·)</button>` : '<span style="color:var(--neon-orange);font-size:12px;">å·²æ»¡çº§</span>'}
                    <button class="btn btn-secondary" onclick="showAssignModal(${emp.id})">åˆ†é…</button>
                    <button class="btn btn-danger" onclick="fireEmployee(${emp.id})">è¾é€€</button>
                </div>
                <div style="margin-top:8px;font-size:11px;color:var(--fg-secondary);">è¾é€€å°†è¿”è¿˜ ${totalUpgradeCost} ç‚¹å·</div>
            </div>`;
        }

        function renderShop() {
            const container = document.getElementById('shopList');
            const trains = trainData[currentShopTab];
            container.innerHTML = trains.map(train => {
                const requiredLevel = train.level || 1;
                const typeLimits = { normal: 20, intercity: 24, highspeed: 28, anime: 33, zodiac: 999 };
                const currentTypeCount = gameState.ownedTrains.filter(t => t.type === currentShopTab).length;
                const canBuy = gameState.gold >= train.price && currentTypeCount < typeLimits[currentShopTab] && gameState.level >= requiredLevel;
                const levelOk = gameState.level >= requiredLevel;
                const comfort = train.comfort || 100;
                const comfortBonus = (comfort / 100).toFixed(1);
                return `<div class="train-card">
                    <div class="train-name">${train.name}</div>
                    <span class="train-type type-${currentShopTab}">${trainTypes[currentShopTab].name}</span>
                    <div class="train-stats"><span>âš¡ ${train.speed} km/h</span><span>âš–ï¸ ${train.weight} t</span></div>
                    <div class="train-stats"><span>ğŸ›‹ï¸ ${comfort}</span><span style="color:var(--neon-yellow);">æ”¶å…¥+${comfortBonus}%</span></div>
                    <div style="font-size:11px;color:var(--fg-secondary);margin:8px 0;">éœ€è¦ç­‰çº§: <span style="color:${levelOk ? 'var(--neon-green)' : 'var(--neon-red)'};">${requiredLevel}</span></div>
                    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-family:'Orbitron',sans-serif;font-size:14px;color:var(--neon-yellow);">${formatNumber(train.price)}</span>
                        <button class="btn btn-primary btn-small" onclick="buyTrain('${currentShopTab}', '${train.name}', ${train.speed}, ${train.weight}, ${train.price}, ${requiredLevel})" ${canBuy ? '' : 'disabled'}>è´­ä¹°</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderRunningTrains() {
            const container = document.getElementById('runningTrainList');
            if (gameState.runningTrains.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:50px;font-size:13px;">// æš‚æ— è¿è¥ä¸­çš„ç«è½¦</div>';
                return;
            }
            container.innerHTML = gameState.runningTrains.map(rt => {
                const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
                const progress = ((rt.totalTime - rt.remainingTime) / rt.totalTime * 100).toFixed(1);
                const rtIndex = gameState.runningTrains.indexOf(rt);
                const comfort = train.comfort || 100;
                const comfortBonus = (comfort / 100).toFixed(1);
                return `<div class="running-train">
                    <div class="train-route"><strong>${train.name}</strong><span style="color:var(--neon-cyan);">${rt.startCity}</span><span style="color:var(--fg-secondary);">â†’</span><span style="color:var(--neon-magenta);">${rt.endCity}</span></div>
                    <div style="font-size:10px;color:var(--neon-yellow);margin:4px 0;">ğŸ›‹ï¸${comfort} (+${comfortBonus}%)</div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${progress}%"></div></div>
                    <div style="display:flex;justify-content:space-between;align-items:center;font-size:11px;color:var(--fg-secondary);">
                        <span>å‰©ä½™: ${rt.remainingTime}s</span>
                        <span style="color:var(--neon-green);">+${formatNumber(rt.earnings)}</span>
                        <button class="btn btn-danger btn-small" onclick="cancelRoute(${rtIndex})" style="padding:2px 8px;font-size:10px;">å–æ¶ˆ</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderCityUnlockList() {
            const container = document.getElementById('cityUnlockList');
            // åˆå¹¶åŸå¸‚åˆ—è¡¨å¹¶å»é‡
            const allCitiesRaw = [...cities.china, ...cities.world];
            const allCitiesUnique = allCitiesRaw.filter((city, index, self) => 
                index === self.findIndex(c => c.name === city.name)
            );
            
            // åˆ†ç¦»å·²è§£é”å’Œæœªè§£é”çš„åŸå¸‚
            const unlockedCities = allCitiesUnique.filter(c => isCityUnlocked(c.name));
            const lockedCities = allCitiesUnique.filter(c => !isCityUnlocked(c.name));
            
            let html = '';
            
            // æ˜¾ç¤ºå·²è§£é”çš„åŸå¸‚
            if (unlockedCities.length > 0) {
                html += `<div style="margin-bottom:15px;">
                    <div style="color:var(--neon-green);font-size:12px;margin-bottom:10px;font-weight:600;">âœ“ å·²è§£é”åŸå¸‚ (${unlockedCities.length})</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;">
                        ${unlockedCities.map(city => `
                            <div class="train-card" style="border-color:var(--neon-green);background:rgba(0,255,136,0.05);">
                                <div class="train-name" style="color:var(--neon-green);">${city.name}</div>
                                <div style="font-size:11px;color:var(--fg-secondary);margin:8px 0;">ç­‰çº§: <span style="color:var(--neon-cyan);">${city.unlockLevel}</span> | è´¹ç”¨: <span style="color:var(--neon-yellow);">${formatNumber(city.unlockCost)}</span></div>
                                <button class="btn btn-danger btn-small" onclick="showLockCityModal('${city.name}')" style="width:100%;">å…³é—­åŸå¸‚</button>
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }
            
            // æ˜¾ç¤ºæœªè§£é”çš„åŸå¸‚
            if (lockedCities.length > 0) {
                html += `<div>
                    <div style="color:var(--neon-cyan);font-size:12px;margin-bottom:10px;font-weight:600;">ğŸ”’ æœªè§£é”åŸå¸‚ (${lockedCities.length})</div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;">
                        ${lockedCities.sort((a, b) => a.unlockLevel - b.unlockLevel).map(city => {
                            const canUnlock = gameState.level >= city.unlockLevel && gameState.gold >= city.unlockCost;
                            return `<div class="train-card">
                                <div class="train-name">${city.name}</div>
                                <div style="font-size:11px;color:var(--fg-secondary);margin:8px 0;">éœ€è¦ç­‰çº§: <span style="color:var(--neon-cyan);">${city.unlockLevel}</span> | è´¹ç”¨: <span style="color:var(--neon-yellow);">${formatNumber(city.unlockCost)}</span></div>
                                <button class="btn btn-primary btn-small" onclick="showUnlockCityModal('${city.name}')" ${canUnlock ? '' : 'disabled'}>${gameState.level < city.unlockLevel ? 'ç­‰çº§ä¸è¶³' : gameState.gold < city.unlockCost ? 'é‡‘å¸ä¸è¶³' : 'è§£é”'}</button>
                            </div>`;
                        }).join('')}
                    </div>
                </div>`;
            }
            
            if (!html) {
                html = '<div style="text-align:center;color:var(--fg-secondary);padding:50px;font-size:13px;">// æš‚æ— åŸå¸‚æ•°æ®</div>';
            }
            
            container.innerHTML = html;
        }

        function renderUpgradePanel() {
            document.getElementById('currentBonus').textContent = `+${gameState.incomeBonus}%`;
            document.getElementById('upgradeBonusBtn').disabled = gameState.points < 3000;
            
            const select = document.getElementById('trainUpgradeSelect');
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç«è½¦ --</option>' +
                gameState.ownedTrains.map(t => `<option value="${t.id}">${t.name} ${t.upgradeLevel ? 'Lv.' + t.upgradeLevel : 'æœªæ”¹é€ '}</option>`).join('');
            document.getElementById('trainUpgradeDetail').innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:30px;font-size:12px;">// è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ç«è½¦</div>';
        }

        function showTrainUpgradeDetail() {
            const trainId = parseFloat(document.getElementById('trainUpgradeSelect').value);
            const container = document.getElementById('trainUpgradeDetail');
            if (!trainId) {
                container.innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:30px;font-size:12px;">// è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ç«è½¦</div>';
                return;
            }
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            
            if (isTrainRestricted(train)) {
                container.innerHTML = `<div class="train-card">
                    <div class="train-name">${train.name}</div>
                    <span class="train-type type-${train.type}">${trainTypes[train.type].name}</span>
                    <div style="margin:12px 0;color:var(--neon-orange);font-size:12px;text-align:center;">
                        âš ï¸ è¯¥ç«è½¦éœ€è¦è¾¾åˆ°54çº§æ‰èƒ½è¿›è¡Œå‡çº§ï¼<br>
                        å½“å‰ç­‰çº§ï¼š${gameState.level}çº§
                    </div>
                </div>`;
                return;
            }
            
            const upgradeLevel = train.upgradeLevel || 0;
            const upgradeCost = calculateTrainUpgradeCost(upgradeLevel + 1);
            const canUpgrade = upgradeLevel < 20 && gameState.points >= upgradeCost;
            
            container.innerHTML = `<div class="train-card">
                <div class="train-name">${train.name} <span class="upgrade-level">${upgradeLevel > 0 ? 'Lv.' + upgradeLevel : 'æœªæ”¹é€ '}</span></div>
                <span class="train-type type-${train.type}">${trainTypes[train.type].name}</span>
                <div style="margin:12px 0;"><div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fg-secondary);"><span>æ”¶ç›ŠåŠ æˆ: <span style="color:var(--neon-magenta);">+${(upgradeLevel * 0.5).toFixed(1)}%</span></span><span>ç­‰çº§: ${upgradeLevel}/20</span></div>
                <div class="progress-bar"><div class="progress-fill" style="width:${(upgradeLevel/20)*100}%"></div></div></div>
                ${upgradeLevel < 20 ? `<button class="btn btn-primary" onclick="upgradeTrain(${train.id})" ${canUpgrade ? '' : 'disabled'}>å‡çº§ (${upgradeCost} ç‚¹å·)</button>` : '<span style="color:var(--neon-orange);font-size:12px;">å·²æ»¡çº§</span>'}
            </div>`;
        }

        function renderRedeemPanel() {
            document.getElementById('redeemCodeInput').value = '';
            const history = gameState.usedRedeemCodes || [];
            document.getElementById('redeemHistory').innerHTML = history.length > 0 
                ? `<div class="section-title">å·²ä½¿ç”¨å…‘æ¢ç </div>${history.map(c => `<div style="color:var(--neon-green);font-size:11px;margin:5px 0;">âœ“ ${c}</div>`).join('')}` 
                : '<div style="color:var(--fg-secondary);text-align:center;padding:20px;font-size:12px;">// æš‚æ— ä½¿ç”¨è®°å½•</div>';
        }

        // ==================== ç«è½¦æ”¹é€ ç³»ç»Ÿ ====================
        function renderReformPanel() {
            document.getElementById('reformStonesCount').textContent = gameState.reformStones || 0;
            document.getElementById('dailyReformStones').textContent = gameState.dailyReformStonesEarned || 0;
            
            const select = document.getElementById('reformTrainSelect');
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹©ç«è½¦ --</option>' +
                gameState.ownedTrains.map(t => {
                    const reformLevel = t.reformLevel || 0;
                    return `<option value="${t.id}">${t.name} ${reformLevel > 0 ? 'æ”¹é€ Lv.' + reformLevel : ''}</option>`;
                }).join('');
            document.getElementById('reformTrainInfo').innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:30px;font-size:12px;">// è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ç«è½¦</div>';
        }

        function updateReformInfo() {
            const trainId = parseFloat(document.getElementById('reformTrainSelect').value);
            const container = document.getElementById('reformTrainInfo');
            if (!trainId) {
                container.innerHTML = '<div style="text-align:center;color:var(--fg-secondary);padding:30px;font-size:12px;">// è¯·ä»ä¸Šæ–¹ä¸‹æ‹‰æ¡†é€‰æ‹©ç«è½¦</div>';
                return;
            }
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            
            if (isTrainRestricted(train)) {
                container.innerHTML = `<div class="train-card">
                    <div class="train-name">${train.name}</div>
                    <span class="train-type type-${train.type}">${trainTypes[train.type].name}</span>
                    <div style="margin:12px 0;color:var(--neon-orange);font-size:12px;text-align:center;">
                        âš ï¸ è¯¥ç«è½¦éœ€è¦è¾¾åˆ°54çº§æ‰èƒ½è¿›è¡Œæ”¹é€ ï¼<br>
                        å½“å‰ç­‰çº§ï¼š${gameState.level}çº§
                    </div>
                </div>`;
                return;
            }
            
            const reformLevel = train.reformLevel || 0;
            const comfortReformLevel = train.comfortReformLevel || 0;
            const nextLevel = reformLevel + 1;
            const reformCost = nextLevel * 5;
            const canReform = reformLevel < 25 && gameState.reformStones >= reformCost;
            const speedBonus = reformLevel * 1;
            
            const nextComfortLevel = comfortReformLevel + 1;
            const comfortReformCost = Math.floor(train.purchasePrice * train.purchasePrice * 2.5 * nextComfortLevel);
            const canComfortReform = comfortReformLevel < 100 && gameState.gold >= comfortReformCost;
            const comfort = train.comfort || 100;
            const comfortBonus = comfort / 100;
            
            container.innerHTML = `<div class="train-card">
                <div class="train-name">${train.name} <span class="upgrade-level">${reformLevel > 0 ? 'æ”¹é€ Lv.' + reformLevel : 'æœªæ”¹é€ '}</span></div>
                <span class="train-type type-${train.type}">${trainTypes[train.type].name}</span>
                <div style="margin:12px 0;">
                    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fg-secondary);margin-bottom:8px;">
                        <span>åŸºç¡€é€Ÿåº¦: <span style="color:var(--neon-cyan);">${train.speed} km/h</span></span>
                        <span>é€Ÿåº¦åŠ æˆ: <span style="color:var(--neon-magenta);">+${speedBonus}%</span></span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fg-secondary);margin-bottom:8px;">
                        <span>å®é™…é€Ÿåº¦: <span style="color:var(--neon-green);">${(train.speed * (1 + speedBonus * 0.01)).toFixed(1)} km/h</span></span>
                        <span>æ”¹é€ ç­‰çº§: ${reformLevel}/25</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${(reformLevel/25)*100}%"></div></div>
                </div>
                ${reformLevel < 25 ? `<button class="btn btn-primary" onclick="reformTrain(${train.id})" ${canReform ? '' : 'disabled'}>æ”¹é€ çŸ³æ”¹é€  (æ¶ˆè€— ${reformCost} æ”¹é€ çŸ³)</button>` : '<span style="color:var(--neon-orange);font-size:12px;">é€Ÿåº¦æ”¹é€ å·²æ»¡çº§</span>'}
                
                <div style="margin:12px 0;padding-top:12px;border-top:1px solid var(--border);">
                    <div style="font-size:12px;color:var(--neon-yellow);margin-bottom:8px;">ğŸ›‹ï¸ èˆ’é€‚åº¦æ”¹é€  (æå‡æ”¶å…¥)</div>
                    <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fg-secondary);margin-bottom:8px;">
                        <span>èˆ’é€‚åº¦: <span style="color:var(--neon-yellow);">${comfort}</span> (æ”¶å…¥+${comfortBonus.toFixed(1)}%)</span>
                        <span>æ”¹é€ ç­‰çº§: ${comfortReformLevel}/100</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${(comfortReformLevel/100)*100}%"></div></div>
                </div>
                ${comfortReformLevel < 100 ? `<button class="btn btn-primary" onclick="comfortReformTrain(${train.id})" ${canComfortReform ? '' : 'disabled'} style="background:var(--neon-yellow);">èˆ’é€‚åº¦æ”¹é€  (æ¶ˆè€— ${formatNumber(comfortReformCost)} é‡‘å¸)</button>` : '<span style="color:var(--neon-orange);font-size:12px;">èˆ’é€‚åº¦æ”¹é€ å·²æ»¡çº§</span>'}
            </div>`;
        }

        function getComfortIncreasePercent(level) {
            if (level <= 10) return 0.01;
            if (level <= 30) return 0.02;
            if (level <= 65) return 0.03;
            return 0.05;
        }

        function reformTrain(trainId) {
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            if (!train) return;
            if (isTrainRestricted(train)) {
                showNotification('è¯¥ç«è½¦éœ€è¦è¾¾åˆ°54çº§æ‰èƒ½è¿›è¡Œæ”¹é€ ï¼');
                return;
            }
            
            const reformLevel = train.reformLevel || 0;
            if (reformLevel >= 25) {
                showNotification('è¯¥ç«è½¦å·²è¾¾åˆ°æ”¹é€ ä¸Šé™ï¼');
                return;
            }
            
            const nextLevel = reformLevel + 1;
            const reformCost = nextLevel * 5;
            
            if (gameState.reformStones < reformCost) {
                showNotification('æ”¹é€ çŸ³ä¸è¶³ï¼');
                return;
            }
            
            gameState.reformStones -= reformCost;
            train.reformLevel = nextLevel;
            
            showNotification(`${train.name} æ”¹é€ æˆåŠŸï¼å½“å‰ç­‰çº§: ${nextLevel}ï¼Œé€Ÿåº¦+ ${nextLevel}%`);
            updateUI();
            document.getElementById('reformStonesCount').textContent = gameState.reformStones || 0;
            updateReformInfo();
        }

        function comfortReformTrain(trainId) {
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            if (!train) return;
            if (isTrainRestricted(train)) {
                showNotification('è¯¥ç«è½¦éœ€è¦è¾¾åˆ°54çº§æ‰èƒ½è¿›è¡Œæ”¹é€ ï¼');
                return;
            }
            
            const comfortReformLevel = train.comfortReformLevel || 0;
            if (comfortReformLevel >= 100) {
                showNotification('è¯¥ç«è½¦èˆ’é€‚åº¦æ”¹é€ å·²è¾¾åˆ°ä¸Šé™ï¼');
                return;
            }
            
            const nextLevel = comfortReformLevel + 1;
            const comfortReformCost = Math.floor(train.purchasePrice * train.purchasePrice * 2.5 * nextLevel);
            
            if (gameState.gold < comfortReformCost) {
                showNotification('é‡‘å¸ä¸è¶³ï¼');
                return;
            }
            
            gameState.gold -= comfortReformCost;
            train.comfortReformLevel = nextLevel;
            const comfortIncreasePercent = getComfortIncreasePercent(nextLevel);
            const baseComfort = trainData[train.type] ? (trainData[train.type].find(t => t.name === train.name)?.comfort || 100) : 100;
            const comfortIncrease = Math.floor(baseComfort * comfortIncreasePercent);
            train.comfort = (train.comfort || baseComfort) + comfortIncrease;
            
            showNotification(`${train.name} èˆ’é€‚åº¦æ”¹é€ æˆåŠŸï¼èˆ’é€‚åº¦+${comfortIncrease}ï¼ˆ+${(comfortIncreasePercent * 100).toFixed(0)}%ï¼‰ï¼Œå½“å‰èˆ’é€‚åº¦: ${train.comfort}`);
            updateUI();
            updateReformInfo();
        }

        function renderRightPanel() {
            const container = document.getElementById('runningInfo');
            if (gameState.runningTrains.length === 0) {
                container.innerHTML = '<div style="color:var(--fg-secondary);text-align:center;padding:30px;font-size:12px;">// æš‚æ— è¿è¥ä¸­çš„ç«è½¦</div>';
                return;
            }
            container.innerHTML = gameState.runningTrains.slice(0, 5).map(rt => {
                const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
                const progress = ((rt.totalTime - rt.remainingTime) / rt.totalTime * 100).toFixed(0);
                const comfort = train.comfort || 100;
                const comfortBonus = (comfort / 100).toFixed(1);
                return `<div class="running-train" style="margin-bottom:10px;">
                    <div style="font-size:12px;font-weight:600;margin-bottom:6px;color:var(--fg-primary);">${train.name}</div>
                    <div style="font-size:10px;color:var(--fg-secondary);margin-bottom:6px;">${rt.startCity} â†’ ${rt.endCity}</div>
                    <div style="font-size:10px;color:var(--neon-yellow);margin-bottom:4px;">ğŸ›‹ï¸${comfort} (+${comfortBonus}%)</div>
                    <div class="progress-bar" style="height:3px;margin:6px 0;"><div class="progress-fill" style="width:${progress}%"></div></div>
                    <div style="font-size:10px;color:var(--neon-cyan);">${rt.remainingTime}s | +${formatNumber(rt.earnings)}</div>
                </div>`;
            }).join('') + (gameState.runningTrains.length > 5 ? `<div style="text-align:center;color:var(--fg-secondary);font-size:10px;margin-top:8px;">... è¿˜æœ‰ ${gameState.runningTrains.length - 5} è¾†</div>` : '');
        }

        // ==================== åœ°å›¾ç³»ç»Ÿ ====================
        let currentMapTab = 'china';
        let mapAnimationId = null;
        let mapZoom = 1;
        let mapOffsetX = 0;
        let mapOffsetY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let trainAnimationPhase = 0;

        function showMapTab(tab) {
            currentMapTab = tab;
            document.querySelectorAll('#mapPanel .tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ›´æ–°åœ°å›¾æ ‡é¢˜
            const mapTitle = document.getElementById('mapTitle');
            if (mapTitle) {
                mapTitle.textContent = tab === 'china' ? 'CHINA MAP' : 'WORLD MAP';
            }
            
            resetMapZoom();
            renderMap();
        }

        function zoomInMap() {
            mapZoom = Math.min(mapZoom * 1.2, 5);
            updateZoomLevel();
            renderMap();
        }

        function zoomOutMap() {
            mapZoom = Math.max(mapZoom / 1.2, 0.5);
            updateZoomLevel();
            renderMap();
        }

        function resetMapZoom() {
            mapZoom = 1;
            mapOffsetX = 0;
            mapOffsetY = 0;
            updateZoomLevel();
            renderMap();
        }

        function updateZoomLevel() {
            document.getElementById('mapZoomLevel').textContent = Math.round(mapZoom * 100) + '%';
        }

        function initMapControls() {
            const canvas = document.getElementById('mapCanvas');
            
            // é¼ æ ‡æ»šè½®ç¼©æ”¾
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                mapZoom = Math.max(0.5, Math.min(3, mapZoom * delta));
                updateZoomLevel();
                renderMap();
            });

            // é¼ æ ‡æ‹–æ‹½æ—‹è½¬åœ°çƒä»ª
            canvas.addEventListener('mousedown', (e) => {
                globeDragging = true;
                globeAutoRotate = false;
                globeLastMouseX = e.clientX;
                globeLastMouseY = e.clientY;
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', (e) => {
                if (globeDragging) {
                    const deltaX = e.clientX - globeLastMouseX;
                    const deltaY = e.clientY - globeLastMouseY;
                    globeRotationY += deltaX * 0.01;
                    globeRotationX = Math.max(-1.2, Math.min(1.2, globeRotationX - deltaY * 0.005));
                    globeLastMouseX = e.clientX;
                    globeLastMouseY = e.clientY;
                    renderMap();
                }
            });

            canvas.addEventListener('mouseup', () => {
                globeDragging = false;
                // 3ç§’åæ¢å¤è‡ªåŠ¨æ—‹è½¬
                setTimeout(() => { globeAutoRotate = true; }, 3000);
                canvas.style.cursor = 'grab';
            });

            canvas.addEventListener('mouseleave', () => {
                globeDragging = false;
                setTimeout(() => { globeAutoRotate = true; }, 3000);
                canvas.style.cursor = 'grab';
            });
            
            // åŒå‡»æ¢å¤è‡ªåŠ¨æ—‹è½¬
            canvas.addEventListener('dblclick', () => {
                globeAutoRotate = true;
                showNotification('å·²æ¢å¤è‡ªåŠ¨æ—‹è½¬');
            });
        }

        // åœ°çƒä»ªå‚æ•°
        let globeRotationX = 0.3; // ä¿¯ä»°è§’
        let globeRotationY = -1.83;   // æ°´å¹³æ—‹è½¬è§’ï¼ˆ-105Â°ï¼Œä½¿ä¸­å›½å±…ä¸­æ˜¾ç¤ºï¼‰
        let globeAutoRotate = true;
        let globeDragging = false;
        let globeLastMouseX = 0;
        let globeLastMouseY = 0;
        
        // åŸå¸‚éšæœºé¢œè‰²ï¼ˆæ¯ä¸ªåŸå¸‚åˆ†é…ä¸€ä¸ªå›ºå®šé¢œè‰²ï¼‰
        const cityColors = {};
        const rainbowColors = [
            '#ff0066', '#ff6600', '#ffcc00', '#66ff00', '#00ff66',
            '#00ffcc', '#00ccff', '#0066ff', '#6600ff', '#cc00ff',
            '#ff00cc', '#ff3366', '#ff9933', '#ffff33', '#33ff33',
            '#33ffff', '#3399ff', '#9933ff', '#ff33ff', '#ff6699'
        ];
        
        function getCityColor(cityName) {
            if (!cityColors[cityName]) {
                const hash = cityName.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                cityColors[cityName] = rainbowColors[hash % rainbowColors.length];
            }
            return cityColors[cityName];
        }
        
        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }
        
        function shadeColor(color, percent) {
            const num = parseInt(color.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
                (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
                (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
        }
        
        function renderMap() {
            const canvas = document.getElementById('mapCanvas');
            const container = document.getElementById('mapContainer');
            
            // è®¾ç½®canvaså°ºå¯¸
            canvas.width = container.offsetWidth * 2;
            canvas.height = container.offsetHeight * 2;
            const ctx = canvas.getContext('2d');
            ctx.scale(2, 2);
            
            const width = container.offsetWidth;
            const height = container.offsetHeight;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.38 * mapZoom;
            
            // æ¸…ç©ºç”»å¸ƒ - æ·±ç©ºæ¸å˜èƒŒæ™¯
            const bgGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, Math.max(width, height) * 0.8);
            bgGradient.addColorStop(0, '#0d0d1a');
            bgGradient.addColorStop(0.3, '#080812');
            bgGradient.addColorStop(0.6, '#040408');
            bgGradient.addColorStop(1, '#000002');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, width, height);
            
            // ç»˜åˆ¶æ˜Ÿäº‘èƒŒæ™¯
            const time = Date.now() * 0.0001;
            for (let i = 0; i < 3; i++) {
                const nebulaX = width * (0.2 + i * 0.3);
                const nebulaY = height * (0.3 + Math.sin(time + i) * 0.1);
                const nebulaGradient = ctx.createRadialGradient(nebulaX, nebulaY, 0, nebulaX, nebulaY, 150);
                const hue = (240 + i * 40 + time * 10) % 360;
                nebulaGradient.addColorStop(0, `hsla(${hue}, 80%, 50%, 0.03)`);
                nebulaGradient.addColorStop(0.5, `hsla(${hue}, 70%, 40%, 0.02)`);
                nebulaGradient.addColorStop(1, 'transparent');
                ctx.fillStyle = nebulaGradient;
                ctx.fillRect(0, 0, width, height);
            }
            
            // ç»˜åˆ¶å¤šå±‚æ˜Ÿç©º
            // è¿œæ™¯æ˜Ÿæ˜Ÿ - å°è€Œæš—
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            for (let i = 0; i < 200; i++) {
                const sx = (Math.sin(i * 123.456 + i * 0.1) * 0.5 + 0.5) * width;
                const sy = (Math.cos(i * 789.012 + i * 0.05) * 0.5 + 0.5) * height;
                const twinkle = 0.5 + Math.sin(time * 50 + i * 2) * 0.5;
                ctx.globalAlpha = 0.15 * twinkle;
                ctx.beginPath();
                ctx.arc(sx, sy, 0.5, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // ä¸­æ™¯æ˜Ÿæ˜Ÿ - ä¸­ç­‰äº®åº¦
            ctx.globalAlpha = 1;
            for (let i = 0; i < 80; i++) {
                const sx = (Math.sin(i * 456.789 + i) * 0.5 + 0.5) * width;
                const sy = (Math.cos(i * 321.654 + i * 0.3) * 0.5 + 0.5) * height;
                const twinkle = 0.6 + Math.sin(time * 30 + i * 3) * 0.4;
                const size = 0.8 + Math.random() * 0.5;
                ctx.fillStyle = `rgba(255, 255, 255, ${0.4 * twinkle})`;
                ctx.beginPath();
                ctx.arc(sx, sy, size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // è¿‘æ™¯äº®æ˜Ÿ - å¸¦å…‰æ™•
            for (let i = 0; i < 20; i++) {
                const sx = (Math.sin(i * 111.222 + i * 0.5) * 0.5 + 0.5) * width;
                const sy = (Math.cos(i * 333.444 + i * 0.2) * 0.5 + 0.5) * height;
                const twinkle = 0.7 + Math.sin(time * 20 + i * 5) * 0.3;
                const starHue = [0, 30, 60, 180, 220][i % 5];
                
                // æ˜Ÿæ˜Ÿå…‰æ™•
                const starGlow = ctx.createRadialGradient(sx, sy, 0, sx, sy, 8);
                starGlow.addColorStop(0, `hsla(${starHue}, 50%, 90%, ${0.8 * twinkle})`);
                starGlow.addColorStop(0.3, `hsla(${starHue}, 60%, 70%, ${0.3 * twinkle})`);
                starGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = starGlow;
                ctx.beginPath();
                ctx.arc(sx, sy, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // æ˜Ÿæ˜Ÿæ ¸å¿ƒ
                ctx.fillStyle = `rgba(255, 255, 255, ${twinkle})`;
                ctx.beginPath();
                ctx.arc(sx, sy, 1.5, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // æµæ˜Ÿæ•ˆæœ - æ›´æ…¢æ›´ä¼˜é›…
            if (Math.random() < 0.005) {
                const meteorX = Math.random() * width;
                const meteorY = Math.random() * height * 0.5;
                const meteorLen = 50 + Math.random() * 80;
                const meteorAngle = Math.PI / 4 + Math.random() * 0.3;
                
                // æµæ˜Ÿå¤´éƒ¨å…‰æ™•
                const headGlow = ctx.createRadialGradient(meteorX, meteorY, 0, meteorX, meteorY, 6);
                headGlow.addColorStop(0, 'rgba(255, 255, 255, 1)');
                headGlow.addColorStop(0.3, 'rgba(200, 220, 255, 0.8)');
                headGlow.addColorStop(1, 'transparent');
                ctx.fillStyle = headGlow;
                ctx.beginPath();
                ctx.arc(meteorX, meteorY, 6, 0, Math.PI * 2);
                ctx.fill();
                
                // æµæ˜Ÿå°¾è¿¹ - æ¸å˜
                const tailGradient = ctx.createLinearGradient(meteorX, meteorY, 
                    meteorX + Math.cos(meteorAngle) * meteorLen, meteorY + Math.sin(meteorAngle) * meteorLen);
                tailGradient.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
                tailGradient.addColorStop(0.3, 'rgba(200, 220, 255, 0.5)');
                tailGradient.addColorStop(0.7, 'rgba(150, 180, 255, 0.2)');
                tailGradient.addColorStop(1, 'transparent');
                ctx.strokeStyle = tailGradient;
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(meteorX, meteorY);
                ctx.lineTo(meteorX + Math.cos(meteorAngle) * meteorLen, meteorY + Math.sin(meteorAngle) * meteorLen);
                ctx.stroke();
            }
            
            // è‡ªåŠ¨æ—‹è½¬
            if (globeAutoRotate && !globeDragging) {
                globeRotationY += 0.003;
            }
            
            // åº”ç”¨åç§»
            const offsetX = mapOffsetX;
            const offsetY = mapOffsetY;
            const globeX = centerX + offsetX;
            const globeY = centerY + offsetY;
            
            // å‘¼å¸æ•ˆæœ - å¹³æ»‘çš„æ­£å¼¦æ³¢åŠ¨ç”»
            const breathePhase = time * 8; // å‘¼å¸å‘¨æœŸ
            const breatheScale = 1 + Math.sin(breathePhase) * 0.015; // è½»å¾®ç¼©æ”¾
            const breatheGlow = 0.7 + Math.sin(breathePhase) * 0.3; // å…‰æ™•å¼ºåº¦å˜åŒ–
            const breathePulse = Math.sin(breathePhase * 2) * 0.5 + 0.5; // è„‰å†²æ•ˆæœ
            
            // ç»˜åˆ¶åœ°çƒå¤§æ°”å±‚ - å¤šå±‚å…‰æ™• + å‘¼å¸æ•ˆæœ
            // æœ€å¤–å±‚å…‰æ™• - å‘¼å¸è„‰åŠ¨
            const atmosphereOuter = ctx.createRadialGradient(globeX, globeY, radius * 0.95, globeX, globeY, radius * (1.8 + breathePulse * 0.2));
            atmosphereOuter.addColorStop(0, `rgba(80, 160, 220, ${0.2 * breatheGlow})`);
            atmosphereOuter.addColorStop(0.3, `rgba(60, 140, 200, ${0.1 * breatheGlow})`);
            atmosphereOuter.addColorStop(0.6, `rgba(40, 120, 180, ${0.05 * breatheGlow})`);
            atmosphereOuter.addColorStop(1, 'transparent');
            ctx.fillStyle = atmosphereOuter;
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius * (1.8 + breathePulse * 0.2), 0, Math.PI * 2);
            ctx.fill();
            
            // ä¸­å±‚å¤§æ°”å…‰æ™• - å‘¼å¸æ•ˆæœ
            const atmosphereMid = ctx.createRadialGradient(globeX, globeY, radius * 0.98, globeX, globeY, radius * (1.3 + breathePulse * 0.1));
            atmosphereMid.addColorStop(0, `rgba(120, 200, 255, ${0.3 * breatheGlow})`);
            atmosphereMid.addColorStop(0.5, `rgba(80, 160, 220, ${0.15 * breatheGlow})`);
            atmosphereMid.addColorStop(1, 'transparent');
            ctx.fillStyle = atmosphereMid;
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius * (1.3 + breathePulse * 0.1), 0, Math.PI * 2);
            ctx.fill();
            
            // å†…å±‚å¤§æ°”è¾¹ç¼˜å…‰ - å‘¼å¸é—ªçƒ
            const atmosphereInner = ctx.createRadialGradient(globeX, globeY, radius * 0.85, globeX, globeY, radius * (1.05 + breathePulse * 0.02));
            atmosphereInner.addColorStop(0, 'transparent');
            atmosphereInner.addColorStop(0.7, `rgba(150, 220, 255, ${0.15 * breatheGlow})`);
            atmosphereInner.addColorStop(0.9, `rgba(180, 230, 255, ${0.35 * breatheGlow})`);
            atmosphereInner.addColorStop(1, `rgba(200, 240, 255, ${0.5 * breatheGlow})`);
            ctx.fillStyle = atmosphereInner;
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius * (1.05 + breathePulse * 0.02), 0, Math.PI * 2);
            ctx.fill();
            
            // å‘¼å¸å…‰ç¯ - å¤–å›´åŠ¨æ€å…‰ç¯
            const ringAlpha = 0.1 + breathePulse * 0.15;
            const ringRadius = radius * (1.15 + breathePulse * 0.05);
            ctx.strokeStyle = `rgba(100, 200, 255, ${ringAlpha})`;
            ctx.lineWidth = 2 + breathePulse * 2;
            ctx.beginPath();
            ctx.arc(globeX, globeY, ringRadius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç¬¬äºŒå±‚å‘¼å¸å…‰ç¯
            const ring2Alpha = 0.05 + breathePulse * 0.1;
            const ring2Radius = radius * (1.35 + breathePulse * 0.08);
            ctx.strokeStyle = `rgba(80, 180, 240, ${ring2Alpha})`;
            ctx.lineWidth = 1 + breathePulse;
            ctx.beginPath();
            ctx.arc(globeX, globeY, ring2Radius, 0, Math.PI * 2);
            ctx.stroke();
            
            // ç»˜åˆ¶åœ°çƒä¸»ä½“ - å¤šå±‚æ¸å˜çƒä½“
            // åŸºç¡€æµ·æ´‹å±‚ - æ·±é‚ƒçš„æµ·æ´‹æ•ˆæœ
            const oceanGradient = ctx.createRadialGradient(
                globeX - radius * 0.3, 
                globeY - radius * 0.3, 
                0, 
                globeX, 
                globeY, 
                radius
            );
            oceanGradient.addColorStop(0, '#2a6a9a');
            oceanGradient.addColorStop(0.3, '#1a5a8a');
            oceanGradient.addColorStop(0.6, '#0a4a7a');
            oceanGradient.addColorStop(1, '#003a6a');
            
            ctx.fillStyle = oceanGradient;
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // å¼€å§‹è£å‰ªåŒºåŸŸ
            ctx.save();
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius, 0, Math.PI * 2);
            ctx.clip();
            
            // ç»˜åˆ¶æµ·æ´‹æµåŠ¨æ•ˆæœ - å¤šå±‚åŠ¨æ€æ³¢çº¹
            const oceanTime = time * 15;
            for (let layer = 0; layer < 3; layer++) {
                const layerAlpha = 0.08 - layer * 0.02;
                const layerSpeed = 1 + layer * 0.5;
                const layerDensity = 8 + layer * 4;
                
                for (let i = 0; i < layerDensity; i++) {
                    const baseLat = -70 + (i * 140 / layerDensity);
                    const waveOffset = oceanTime * layerSpeed + i * 0.8;
                    
                    ctx.strokeStyle = `rgba(100, 180, 240, ${layerAlpha})`;
                    ctx.lineWidth = 1.5 - layer * 0.3;
                    ctx.beginPath();
                    
                    let started = false;
                    for (let lng = -180; lng <= 180; lng += 4) {
                        const lat = baseLat + Math.sin(lng * 0.03 + waveOffset) * 8 + Math.sin(lng * 0.07 + waveOffset * 1.5) * 4;
                        const pos = projectToGlobe(lat, lng, radius, globeRotationX, globeRotationY, globeX, globeY);
                        
                        if (pos.visible) {
                            if (!started) {
                                ctx.moveTo(pos.x, pos.y);
                                started = true;
                            } else {
                                ctx.lineTo(pos.x, pos.y);
                            }
                        }
                    }
                    ctx.stroke();
                }
            }
            
            // æµ·æ´‹æ·±è‰²æµåŠ¨çº¿æ¡
            for (let i = 0; i < 5; i++) {
                const flowLat = -50 + i * 25;
                const flowOffset = oceanTime * 0.8 + i * 1.2;
                
                ctx.strokeStyle = `rgba(30, 100, 160, 0.2)`;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                let started = false;
                for (let lng = -180; lng <= 180; lng += 3) {
                    const lat = flowLat + Math.sin(lng * 0.04 + flowOffset) * 5;
                    const pos = projectToGlobe(lat, lng, radius, globeRotationX, globeRotationY, globeX, globeY);
                    
                    if (pos.visible) {
                        if (!started) {
                            ctx.moveTo(pos.x, pos.y);
                            started = true;
                        } else {
                            ctx.lineTo(pos.x, pos.y);
                        }
                    }
                }
                ctx.stroke();
            }
            
            // ç»˜åˆ¶äº‘å±‚æ•ˆæœ
            const cloudTime = time * 5;
            for (let i = 0; i < 12; i++) {
                const cloudLat = -60 + (i % 6) * 25;
                const cloudLng = -150 + Math.floor(i / 6) * 120 + cloudTime * 2;
                const cloudPos = projectToGlobe(cloudLat, cloudLng, radius * 1.02, globeRotationX, globeRotationY, globeX, globeY);
                
                if (cloudPos.visible) {
                    const cloudSize = 15 + Math.sin(i * 2.5) * 8;
                    const cloudAlpha = 0.08 + Math.sin(cloudTime + i) * 0.03;
                    
                    // äº‘å›¢
                    const cloudGradient = ctx.createRadialGradient(cloudPos.x, cloudPos.y, 0, cloudPos.x, cloudPos.y, cloudSize);
                    cloudGradient.addColorStop(0, `rgba(255, 255, 255, ${cloudAlpha})`);
                    cloudGradient.addColorStop(0.5, `rgba(255, 255, 255, ${cloudAlpha * 0.5})`);
                    cloudGradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = cloudGradient;
                    ctx.beginPath();
                    ctx.arc(cloudPos.x, cloudPos.y, cloudSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // äº‘å›¢å»¶ä¼¸
                    for (let j = 0; j < 3; j++) {
                        const offsetX = Math.cos(j * 2.1) * cloudSize * 0.6;
                        const offsetY = Math.sin(j * 2.1) * cloudSize * 0.3;
                        ctx.fillStyle = `rgba(255, 255, 255, ${cloudAlpha * 0.6})`;
                        ctx.beginPath();
                        ctx.arc(cloudPos.x + offsetX, cloudPos.y + offsetY, cloudSize * 0.5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
            
            // ç»˜åˆ¶ç»çº¬çº¿ç½‘æ ¼ - æ›´ç²¾ç¾çš„æ ·å¼
            // ç»çº¿ - æ¸å˜æ•ˆæœ
            for (let lng = -180; lng < 180; lng += 30) {
                const gradient = ctx.createLinearGradient(
                    globeX - radius, globeY - radius,
                    globeX + radius, globeY + radius
                );
                gradient.addColorStop(0, 'rgba(100, 200, 255, 0.08)');
                gradient.addColorStop(0.5, 'rgba(100, 200, 255, 0.2)');
                gradient.addColorStop(1, 'rgba(100, 200, 255, 0.08)');
                ctx.strokeStyle = gradient;
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                for (let lat = -90; lat <= 90; lat += 3) {
                    const pos = projectToGlobe(lat, lng, radius, globeRotationX, globeRotationY, globeX, globeY);
                    if (pos.visible) {
                        if (lat === -90) ctx.moveTo(pos.x, pos.y);
                        else ctx.lineTo(pos.x, pos.y);
                    }
                }
                ctx.stroke();
            }
            
            // çº¬çº¿ - æ¸å˜æ•ˆæœ
            for (let lat = -60; lat <= 60; lat += 30) {
                const latGradient = ctx.createLinearGradient(
                    globeX - radius, globeY,
                    globeX + radius, globeY
                );
                latGradient.addColorStop(0, 'rgba(100, 200, 255, 0.05)');
                latGradient.addColorStop(0.5, 'rgba(100, 200, 255, 0.18)');
                latGradient.addColorStop(1, 'rgba(100, 200, 255, 0.05)');
                ctx.strokeStyle = latGradient;
                ctx.lineWidth = 0.5;
                ctx.beginPath();
                for (let lng = -180; lng <= 180; lng += 3) {
                    const pos = projectToGlobe(lat, lng, radius, globeRotationX, globeRotationY, globeX, globeY);
                    if (pos.visible) {
                        if (lng === -180) ctx.moveTo(pos.x, pos.y);
                        else ctx.lineTo(pos.x, pos.y);
                    }
                }
                ctx.stroke();
            }
            
            // èµ¤é“çº¿ - ç‰¹æ®Šé«˜äº®
            const equatorGradient = ctx.createLinearGradient(
                globeX - radius, globeY,
                globeX + radius, globeY
            );
            equatorGradient.addColorStop(0, 'rgba(255, 220, 100, 0.15)');
            equatorGradient.addColorStop(0.3, 'rgba(255, 220, 100, 0.5)');
            equatorGradient.addColorStop(0.5, 'rgba(255, 230, 120, 0.6)');
            equatorGradient.addColorStop(0.7, 'rgba(255, 220, 100, 0.5)');
            equatorGradient.addColorStop(1, 'rgba(255, 220, 100, 0.15)');
            ctx.strokeStyle = equatorGradient;
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let lng = -180; lng <= 180; lng += 2) {
                const pos = projectToGlobe(0, lng, radius, globeRotationX, globeRotationY, globeX, globeY);
                if (pos.visible) {
                    if (lng === -180) ctx.moveTo(pos.x, pos.y);
                    else ctx.lineTo(pos.x, pos.y);
                }
            }
            ctx.stroke();
            
            // å›å½’çº¿å’Œæåœˆ
            const specialLats = [23.5, -23.5, 66.5, -66.5];
            specialLats.forEach(slat => {
                ctx.strokeStyle = 'rgba(255, 200, 100, 0.25)';
                ctx.lineWidth = 0.8;
                ctx.setLineDash([3, 3]);
                ctx.beginPath();
                for (let lng = -180; lng <= 180; lng += 3) {
                    const pos = projectToGlobe(slat, lng, radius, globeRotationX, globeRotationY, globeX, globeY);
                    if (pos.visible) {
                        if (lng === -180) ctx.moveTo(pos.x, pos.y);
                        else ctx.lineTo(pos.x, pos.y);
                    }
                }
                ctx.stroke();
                ctx.setLineDash([]);
            });
            
            ctx.restore();
            
            // åœ°çƒè¡¨é¢é«˜å…‰
            const highlightGradient = ctx.createRadialGradient(
                globeX - radius * 0.5,
                globeY - radius * 0.5,
                0,
                globeX - radius * 0.3,
                globeY - radius * 0.3,
                radius * 0.8
            );
            highlightGradient.addColorStop(0, 'rgba(255, 255, 255, 0.2)');
            highlightGradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.08)');
            highlightGradient.addColorStop(1, 'transparent');
            ctx.fillStyle = highlightGradient;
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // åœ°çƒè¾¹ç¼˜å‘å…‰
            const edgeGlow = ctx.createRadialGradient(globeX, globeY, radius * 0.92, globeX, globeY, radius);
            edgeGlow.addColorStop(0, 'transparent');
            edgeGlow.addColorStop(0.5, 'rgba(120, 200, 255, 0.15)');
            edgeGlow.addColorStop(1, 'rgba(180, 230, 255, 0.35)');
            ctx.fillStyle = edgeGlow;
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // è·å–å½“å‰åœ°å›¾çš„åŸå¸‚æ•°æ®
            const currentCities = currentMapTab === 'china' ? cities.china : cities.world;
            
            // æ›´æ–°åŠ¨ç”»ç›¸ä½
            trainAnimationPhase = (trainAnimationPhase + 0.05) % (Math.PI * 2);
            
            // 3DæŠ•å½±å‡½æ•°
            function projectToGlobe(lat, lng, r, rotX, rotY, cx, cy) {
                // å°†ç»çº¬åº¦è½¬æ¢ä¸ºå¼§åº¦
                const latRad = lat * Math.PI / 180;
                const lngRad = lng * Math.PI / 180;
                
                // 3Dåæ ‡
                let x = r * Math.cos(latRad) * Math.sin(lngRad + rotY);
                let y = r * Math.sin(latRad);
                let z = r * Math.cos(latRad) * Math.cos(lngRad + rotY);
                
                // åº”ç”¨ä¿¯ä»°æ—‹è½¬
                const y2 = y * Math.cos(rotX) - z * Math.sin(rotX);
                const z2 = y * Math.sin(rotX) + z * Math.cos(rotX);
                
                return {
                    x: cx + x,
                    y: cy - y2,
                    z: z2,
                    visible: z2 > 0
                };
            }
            
            // ç»˜åˆ¶è¿è¥è·¯çº¿ï¼ˆåœ¨çƒé¢ä¸Šï¼‰
            gameState.runningTrains.forEach(rt => {
                const startCity = getCityByName(rt.startCity);
                const endCity = getCityByName(rt.endCity);
                if (startCity && endCity) {
                    const startDisplayLat = startCity.displayLat !== undefined ? startCity.displayLat : startCity.lat;
                    const startDisplayLng = startCity.displayLng !== undefined ? startCity.displayLng : startCity.lng;
                    const endDisplayLat = endCity.displayLat !== undefined ? endCity.displayLat : endCity.lat;
                    const endDisplayLng = endCity.displayLng !== undefined ? endCity.displayLng : endCity.lng;
                    
                    const pos1 = projectToGlobe(startDisplayLat, startDisplayLng, radius, globeRotationX, globeRotationY, globeX, globeY);
                    const pos2 = projectToGlobe(endDisplayLat, endDisplayLng, radius, globeRotationX, globeRotationY, globeX, globeY);
                    
                    // åªæœ‰å½“ä¸¤ä¸ªåŸå¸‚éƒ½å¯è§æ—¶æ‰ç»˜åˆ¶è·¯çº¿
                    if (pos1.visible && pos2.visible) {
                        // ç»˜åˆ¶çƒé¢æ›²çº¿ - å‘å…‰æ•ˆæœ
                        ctx.shadowColor = 'rgba(0, 212, 255, 0.8)';
                        ctx.shadowBlur = 10;
                        ctx.strokeStyle = 'rgba(0, 212, 255, 0.6)';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.lineDashOffset = -trainAnimationPhase * 10;
                        ctx.beginPath();
                        
                        // ç»˜åˆ¶å¤§åœ†å¼§çº¿
                        const steps = 30;
                        for (let i = 0; i <= steps; i++) {
                            const t = i / steps;
                            const lat = startDisplayLat + (endDisplayLat - startDisplayLat) * t;
                            const lng = startDisplayLng + (endDisplayLng - startDisplayLng) * t;
                            const pos = projectToGlobe(lat, lng, radius, globeRotationX, globeRotationY, globeX, globeY);
                            if (pos.visible) {
                                if (i === 0) ctx.moveTo(pos.x, pos.y);
                                else ctx.lineTo(pos.x, pos.y);
                            }
                        }
                        ctx.stroke();
                        ctx.setLineDash([]);
                        ctx.shadowBlur = 0;
                        
                        // ç»˜åˆ¶ç«è½¦ä½ç½®
                        const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
                        if (train) {
                            const progress = (rt.totalTime - rt.remainingTime) / rt.totalTime;
                            const trainLat = startDisplayLat + (endDisplayLat - startDisplayLat) * progress;
                            const trainLng = startDisplayLng + (endDisplayLng - startDisplayLng) * progress;
                            const trainPos = projectToGlobe(trainLat, trainLng, radius, globeRotationX, globeRotationY, globeX, globeY);
                            
                            if (trainPos.visible) {
                                const trainX = trainPos.x;
                                const trainY = trainPos.y;
                        
                        // è®¡ç®—ç«è½¦æœå‘è§’åº¦
                        const nextT = Math.min(progress + 0.05, 1);
                        const nextLat = startDisplayLat + (endDisplayLat - startDisplayLat) * nextT;
                        const nextLng = startDisplayLng + (endDisplayLng - startDisplayLng) * nextT;
                        const nextPos = projectToGlobe(nextLat, nextLng, radius, globeRotationX, globeRotationY, globeX, globeY);
                        const angle = Math.atan2(nextPos.y - trainY, nextPos.x - trainX);
                        
                        // ç«è½¦å¤–åœˆåŠ¨æ€å‘å…‰æ•ˆæœ
                        const glowSize = 15 + Math.sin(trainAnimationPhase * 3) * 3;
                        const gradient = ctx.createRadialGradient(trainX, trainY, 0, trainX, trainY, glowSize);
                        gradient.addColorStop(0, 'rgba(255, 0, 255, 0.8)');
                        gradient.addColorStop(0.3, 'rgba(255, 0, 255, 0.4)');
                        gradient.addColorStop(0.6, 'rgba(255, 0, 255, 0.15)');
                        gradient.addColorStop(1, 'rgba(255, 0, 255, 0)');
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.arc(trainX, trainY, glowSize, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // ç»˜åˆ¶ç«è½¦å›¾å½¢
                        ctx.save();
                        ctx.translate(trainX, trainY);
                        ctx.rotate(angle);
                        
                        const trainLength = 12;
                        const trainWidth = 6;
                        
                        // ç«è½¦è½¦èº«
                        ctx.fillStyle = '#ff00ff';
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 1;
                        
                        // è½¦å¤´
                        ctx.beginPath();
                        ctx.moveTo(trainLength/2, 0);
                        ctx.lineTo(trainLength/4, -trainWidth/2);
                        ctx.lineTo(-trainLength/2, -trainWidth/2);
                        ctx.lineTo(-trainLength/2, trainWidth/2);
                        ctx.lineTo(trainLength/4, trainWidth/2);
                        ctx.closePath();
                        ctx.fill();
                        ctx.stroke();
                        
                        // è½¦çª—
                        ctx.fillStyle = '#00ffff';
                        ctx.fillRect(-trainLength/4, -trainWidth/3, trainLength/3, trainWidth/1.5);
                        
                        ctx.restore();
                        
                        // ç«è½¦åç§°
                        ctx.fillStyle = '#ff00ff';
                        ctx.font = 'bold 9px "Share Tech Mono", monospace';
                        ctx.textAlign = 'center';
                        ctx.fillText(train.name, trainX, trainY - 18);
                            }
                        }
                    }
                }
            });
            
            // ç»˜åˆ¶åŸå¸‚
            currentCities.forEach((city, index) => {
                const displayLat = city.displayLat !== undefined ? city.displayLat : city.lat;
                const displayLng = city.displayLng !== undefined ? city.displayLng : city.lng;
                const pos = projectToGlobe(displayLat, displayLng, radius, globeRotationX, globeRotationY, globeX, globeY);
                if (!pos.visible) return;
                
                const x = pos.x;
                const y = pos.y;
                const unlocked = isCityUnlocked(city.name);
                
                // æ ¹æ®åŸå¸‚é‡è¦ç¨‹åº¦ç¡®å®šå¤§å°
                const isMajor = city.unlockLevel <= 10 || city.unlockCost >= 10000000;
                const isCapital = city.unlockLevel <= 5 || city.unlockCost >= 50000000;
                const baseSize = isCapital ? 7 : isMajor ? 5 : 4;
                
                // åŸå¸‚å‘å…‰æ•ˆæœ - å¤šå±‚å…‰æ™•
                if (unlocked) {
                    const cityColor = getCityColor(city.name);
                    const breathe = 0.5 + Math.sin(trainAnimationPhase * 2 + index * 0.7) * 0.3;
                    const glowSize = baseSize + 8 + Math.sin(trainAnimationPhase * 2 + index * 0.5) * 3;
                    
                    // æœ€å¤–å±‚å…‰æ™•
                    const outerGlow = ctx.createRadialGradient(x, y, 0, x, y, glowSize + 5);
                    outerGlow.addColorStop(0, hexToRgba(cityColor, breathe * 0.3));
                    outerGlow.addColorStop(0.5, hexToRgba(cityColor, breathe * 0.15));
                    outerGlow.addColorStop(1, hexToRgba(cityColor, 0));
                    ctx.fillStyle = outerGlow;
                    ctx.beginPath();
                    ctx.arc(x, y, glowSize + 5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ä¸­å±‚å‘å…‰
                    const gradient = ctx.createRadialGradient(x, y, 0, x, y, glowSize);
                    gradient.addColorStop(0, hexToRgba(cityColor, breathe));
                    gradient.addColorStop(0.4, hexToRgba(cityColor, breathe * 0.6));
                    gradient.addColorStop(1, hexToRgba(cityColor, 0));
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(x, y, glowSize, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // ç»˜åˆ¶åŸå¸‚å›¾æ ‡
                if (unlocked) {
                    const cityColor = getCityColor(city.name);
                    const breathe = 0.7 + Math.sin(trainAnimationPhase * 2 + index * 0.7) * 0.3;
                    
                    // å·²è§£é”åŸå¸‚ - å‘å…‰æ ¸å¿ƒ
                    ctx.shadowColor = cityColor;
                    ctx.shadowBlur = 8;
                    ctx.fillStyle = hexToRgba(cityColor, breathe);
                    ctx.beginPath();
                    ctx.arc(x, y, baseSize, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // å†…åœˆé«˜å…‰
                    const innerHighlight = ctx.createRadialGradient(x - baseSize * 0.3, y - baseSize * 0.3, 0, x, y, baseSize);
                    innerHighlight.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
                    innerHighlight.addColorStop(0.5, 'rgba(255, 255, 255, 0.1)');
                    innerHighlight.addColorStop(1, 'transparent');
                    ctx.fillStyle = innerHighlight;
                    ctx.beginPath();
                    ctx.arc(x, y, baseSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // å¤–åœˆ
                    ctx.strokeStyle = cityColor;
                    ctx.lineWidth = 1.5;
                    ctx.beginPath();
                    ctx.arc(x, y, baseSize + 2, 0, Math.PI * 2);
                    ctx.stroke();
                    
                    // è„‰å†²ç¯æ•ˆæœ
                    const pulseSize = baseSize + 4 + Math.sin(trainAnimationPhase * 3 + index) * 2;
                    ctx.strokeStyle = hexToRgba(cityColor, 0.3);
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(x, y, pulseSize, 0, Math.PI * 2);
                    ctx.stroke();
                } else {
                    // æœªè§£é”åŸå¸‚ - æ›´é†’ç›®çš„é¢œè‰²
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.beginPath();
                    ctx.arc(x, y, baseSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.strokeStyle = 'rgba(255, 200, 100, 0.8)';
                    ctx.lineWidth = 1.5;
                    ctx.setLineDash([3, 3]);
                    ctx.beginPath();
                    ctx.arc(x, y, baseSize, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // å¤–åœˆæç¤º
                    ctx.strokeStyle = 'rgba(255, 150, 50, 0.4)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.arc(x, y, baseSize + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // åŸå¸‚åç§°
                if (unlocked) {
                    const cityColor = getCityColor(city.name);
                    ctx.shadowColor = cityColor;
                    ctx.shadowBlur = 4;
                    ctx.fillStyle = cityColor;
                    ctx.font = `bold 9px "Share Tech Mono", monospace`;
                    ctx.textAlign = 'center';
                    ctx.fillText(city.name, x, y - baseSize - 6);
                    ctx.shadowBlur = 0;
                } else {
                    // æœªè§£é”åŸå¸‚åç§° - æ›´é†’ç›®
                    ctx.fillStyle = 'rgba(255, 220, 150, 0.9)';
                    ctx.font = 'bold 9px "Share Tech Mono", monospace';
                    ctx.textAlign = 'center';
                    ctx.fillText(city.name, x, y - baseSize - 6);
                }
                
                // å¦‚æœæœªè§£é”,æ˜¾ç¤ºè§£é”ç­‰çº§
                if (!unlocked) {
                    ctx.fillStyle = '#ff6b00';
                    ctx.font = 'bold 8px "Share Tech Mono", monospace';
                    ctx.fillText(`Lv.${city.unlockLevel}`, x, y + baseSize + 12);
                }
            });
            
            // ç»˜åˆ¶åœ°çƒè¾¹ç¼˜é«˜å…‰
            const edgeGradient = ctx.createRadialGradient(
                globeX, 
                globeY, 
                radius * 0.85, 
                globeX, 
                globeY, 
                radius
            );
            edgeGradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
            edgeGradient.addColorStop(0.7, 'rgba(0, 0, 0, 0)');
            edgeGradient.addColorStop(0.85, 'rgba(100, 200, 255, 0.05)');
            edgeGradient.addColorStop(0.95, 'rgba(150, 220, 255, 0.1)');
            edgeGradient.addColorStop(1, 'rgba(200, 240, 255, 0.2)');
            ctx.fillStyle = edgeGradient;
            ctx.beginPath();
            ctx.arc(globeX, globeY, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateMapStats();
            
            // å¯åŠ¨åŠ¨ç”»
            if (mapAnimationId) cancelAnimationFrame(mapAnimationId);
            const animate = () => {
                if (document.getElementById('mapPanel').style.display !== 'none') {
                    renderMap();
                }
            };
            mapAnimationId = requestAnimationFrame(animate);
        }

        function updateMapStats() {
            const statsContainer = document.getElementById('mapStatsContent');
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const totalCities = currentMapTab === 'china' ? cities.china.length : cities.world.length;
            const unlockedCount = (currentMapTab === 'china' ? cities.china : cities.world)
                .filter(c => isCityUnlocked(c.name)).length;
            
            const runningOnMap = gameState.runningTrains.filter(rt => {
                const startCity = getCityByName(rt.startCity);
                const endCity = getCityByName(rt.endCity);
                const currentCities = currentMapTab === 'china' ? cities.china : cities.world;
                return currentCities.some(c => c.name === rt.startCity || c.name === rt.endCity);
            }).length;
            
            const totalEarningsOnMap = gameState.runningTrains
                .filter(rt => {
                    const currentCities = currentMapTab === 'china' ? cities.china : cities.world;
                    return currentCities.some(c => c.name === rt.startCity || c.name === rt.endCity);
                })
                .reduce((sum, rt) => sum + rt.earnings, 0);
            
            statsContainer.innerHTML = `
                <div style="text-align:center;padding:15px;background:linear-gradient(135deg, rgba(0,255,136,0.05), rgba(0,255,136,0.02));border-radius:4px;border:1px solid rgba(0,255,136,0.2);box-shadow:0 0 15px rgba(0,255,136,0.1);">
                    <div style="font-size:28px;font-family:'Orbitron',sans-serif;font-weight:900;color:var(--neon-green);text-shadow:0 0 20px var(--neon-green);">${unlockedCount}/${totalCities}</div>
                    <div style="font-size:11px;color:var(--fg-secondary);margin-top:8px;letter-spacing:1px;">å·²è§£é”åŸå¸‚</div>
                </div>
                <div style="text-align:center;padding:15px;background:linear-gradient(135deg, rgba(0,212,255,0.05), rgba(0,212,255,0.02));border-radius:4px;border:1px solid rgba(0,212,255,0.2);box-shadow:0 0 15px rgba(0,212,255,0.1);">
                    <div style="font-size:28px;font-family:'Orbitron',sans-serif;font-weight:900;color:var(--neon-cyan);text-shadow:0 0 20px var(--neon-cyan);">${runningOnMap}</div>
                    <div style="font-size:11px;color:var(--fg-secondary);margin-top:8px;letter-spacing:1px;">è¿è¥ä¸­ç«è½¦</div>
                </div>
                <div style="text-align:center;padding:15px;background:linear-gradient(135deg, rgba(255,0,255,0.05), rgba(255,0,255,0.02));border-radius:4px;border:1px solid rgba(255,0,255,0.2);box-shadow:0 0 15px rgba(255,0,255,0.1);">
                    <div style="font-size:28px;font-family:'Orbitron',sans-serif;font-weight:900;color:var(--neon-magenta);text-shadow:0 0 20px var(--neon-magenta);">${formatNumber(totalEarningsOnMap)}</div>
                    <div style="font-size:11px;color:var(--fg-secondary);margin-top:8px;letter-spacing:1px;">é¢„è®¡æ”¶ç›Š</div>
                </div>
                <div style="text-align:center;padding:15px;background:linear-gradient(135deg, rgba(255,107,0,0.05), rgba(255,107,0,0.02));border-radius:4px;border:1px solid rgba(255,107,0,0.2);box-shadow:0 0 15px rgba(255,107,0,0.1);">
                    <div style="font-size:28px;font-family:'Orbitron',sans-serif;font-weight:900;color:var(--neon-orange);text-shadow:0 0 20px var(--neon-orange);">${gameState.runningTrains.length}</div>
                    <div style="font-size:11px;color:var(--fg-secondary);margin-top:8px;letter-spacing:1px;">æ€»è¿è¥æ•°</div>
                </div>
            `;
        }

        // ==================== æ¸¸æˆé€»è¾‘ ====================
        function showUnlockCityModal(cityName) {
            const city = getCityByName(cityName);
            pendingUnlockCity = city;
            const canUnlock = gameState.level >= city.unlockLevel && gameState.gold >= city.unlockCost;
            document.getElementById('unlockCityInfo').innerHTML = `
                <div style="text-align:center;margin-bottom:20px;"><div style="font-size:48px;margin-bottom:12px;">ğŸ™ï¸</div><div style="font-size:22px;font-family:'Orbitron',sans-serif;font-weight:700;">${city.name}</div></div>
                <div style="background:rgba(0,255,136,0.03);border:1px solid var(--border);padding:15px;border-radius:2px;margin-bottom:15px;">
                    <div style="display:flex;justify-content:space-between;margin:10px 0;font-size:12px;"><span>éœ€è¦ç­‰çº§:</span><span style="color:${gameState.level >= city.unlockLevel ? 'var(--neon-green)' : 'var(--neon-red)'}">Lv.${city.unlockLevel} ${gameState.level >= city.unlockLevel ? 'âœ“' : '(å½“å‰Lv.' + gameState.level + ')'}</span></div>
                    <div style="display:flex;justify-content:space-between;margin:10px 0;font-size:12px;"><span>è§£é”è´¹ç”¨:</span><span style="color:${gameState.gold >= city.unlockCost ? 'var(--neon-green)' : 'var(--neon-red)'}">${formatNumber(city.unlockCost)} é‡‘å¸</span></div>
                </div>`;
            document.getElementById('confirmUnlockBtn').disabled = !canUnlock;
            document.getElementById('unlockCityModal').classList.add('show');
        }

        function confirmUnlockCity() {
            if (!pendingUnlockCity) return;
            if (gameState.level < pendingUnlockCity.unlockLevel) { showNotification('ç­‰çº§ä¸è¶³ï¼'); return; }
            if (gameState.gold < pendingUnlockCity.unlockCost) { showNotification('é‡‘å¸ä¸è¶³ï¼'); return; }
            gameState.gold -= pendingUnlockCity.unlockCost;
            gameState.unlockedCities.push(pendingUnlockCity.name);
            const unlockedCityName = pendingUnlockCity.name;
            closeUnlockModal();
            updateUI();
            renderRoutePanel();
            renderCityUnlockList();
            showNotification(`æˆåŠŸè§£é” ${unlockedCityName}ï¼`);
        }

        function closeUnlockModal() { document.getElementById('unlockCityModal').classList.remove('show'); pendingUnlockCity = null; }
        
        // ==================== å…³é—­åŸå¸‚åŠŸèƒ½ ====================
        let pendingLockCity = null;
        
        function showLockCityModal(cityName) {
            const city = getCityByName(cityName);
            pendingLockCity = city;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿è¥çš„çº¿è·¯ä½¿ç”¨è¯¥åŸå¸‚
            const runningRoutes = gameState.runningTrains.filter(rt => 
                rt.startCity === cityName || rt.endCity === cityName
            );
            
            let warningHtml = '';
            if (runningRoutes.length > 0) {
                warningHtml = `<div style="background:rgba(255,68,68,0.1);border:1px solid var(--neon-red);padding:12px;border-radius:2px;margin-bottom:15px;">
                    <div style="color:var(--neon-red);font-size:12px;font-weight:600;margin-bottom:8px;">âš ï¸ è­¦å‘Š</div>
                    <div style="color:var(--fg-secondary);font-size:11px;">æœ‰ ${runningRoutes.length} æ¡çº¿è·¯æ­£åœ¨ä½¿ç”¨è¯¥åŸå¸‚ï¼Œå…³é—­åè¿™äº›çº¿è·¯å°†è¢«å–æ¶ˆï¼</div>
                </div>`;
            }
            
            document.getElementById('lockCityInfo').innerHTML = `
                <div style="text-align:center;margin-bottom:20px;">
                    <div style="font-size:48px;margin-bottom:12px;">ğŸ”’</div>
                    <div style="font-size:22px;font-family:'Orbitron',sans-serif;font-weight:700;">${city.name}</div>
                </div>
                ${warningHtml}
                <div style="background:rgba(255,68,68,0.05);border:1px solid var(--border);padding:15px;border-radius:2px;margin-bottom:15px;">
                    <div style="color:var(--neon-red);font-size:13px;margin-bottom:10px;">å…³é—­åè¯¥åŸå¸‚å°†å˜ä¸ºæœªè§£é”çŠ¶æ€ï¼š</div>
                    <div style="font-size:11px;color:var(--fg-secondary);line-height:1.8;">
                        â€¢ åŸå¸‚å°†ä»å·²è§£é”åˆ—è¡¨ä¸­ç§»é™¤<br>
                        â€¢ æ— æ³•ä½œä¸ºçº¿è·¯çš„èµ·ç‚¹æˆ–ç»ˆç‚¹<br>
                        â€¢ éœ€è¦é‡æ–°æ”¯ä»˜è§£é”è´¹ç”¨æ‰èƒ½ä½¿ç”¨<br>
                        â€¢ å·²æœ‰çº¿è·¯ç»è¿‡è¯¥åŸå¸‚çš„å°†è¢«å–æ¶ˆ
                    </div>
                </div>`;
            document.getElementById('lockCityModal').classList.add('show');
        }
        
        function confirmLockCity() {
            if (!pendingLockCity) return;
            const cityName = pendingLockCity.name;
            
            // å–æ¶ˆæ‰€æœ‰ä½¿ç”¨è¯¥åŸå¸‚çš„è¿è¥çº¿è·¯
            const routesToCancel = gameState.runningTrains.filter(rt => 
                rt.startCity === cityName || rt.endCity === cityName
            );
            routesToCancel.forEach(rt => {
                const idx = gameState.runningTrains.indexOf(rt);
                if (idx > -1) gameState.runningTrains.splice(idx, 1);
            });
            
            // ä»å·²è§£é”åŸå¸‚åˆ—è¡¨ä¸­ç§»é™¤
            const cityIndex = gameState.unlockedCities.indexOf(cityName);
            if (cityIndex > -1) {
                gameState.unlockedCities.splice(cityIndex, 1);
            }
            
            closeLockModal();
            updateUI();
            renderRoutePanel();
            renderCityUnlockList();
            renderMap();
            showNotification(`å·²å…³é—­åŸå¸‚ ${cityName}ï¼`);
        }
        
        function closeLockModal() { 
            document.getElementById('lockCityModal').classList.remove('show'); 
            pendingLockCity = null; 
        }

        function buyTrain(type, name, speed, weight, price, level) {
            const requiredLevel = level || 1;
            if (gameState.level < requiredLevel) { showNotification(`éœ€è¦ç­‰çº§ ${requiredLevel} æ‰èƒ½è´­ä¹°æ­¤ç«è½¦ï¼`); return; }
            
            const typeLimits = { normal: 20, intercity: 24, highspeed: 28, anime: 33, zodiac: 999 };
            const currentCount = gameState.ownedTrains.filter(t => t.type === type).length;
            const limit = typeLimits[type] || 80;
            if (currentCount >= limit) {
                const typeNames = { normal: 'æ™®é€šç«è½¦', intercity: 'åŸé™…åˆ—è½¦', highspeed: 'é«˜é“', anime: 'åŠ¨æ¼«è”å', zodiac: 'ç”Ÿè‚–é™å®š' };
                showNotification(`${typeNames[type]}æ•°é‡å·²è¾¾ä¸Šé™(${limit}è¾†)ï¼`);
                return;
            }
            
            if (gameState.gold < price) { showNotification('é‡‘å¸ä¸è¶³ï¼'); return; }
            gameState.gold -= price;
            const trainInfo = trainData[type].find(t => t.name === name);
            const comfort = trainInfo ? trainInfo.comfort : 100;
            gameState.ownedTrains.push({ id: Date.now() + Math.random(), type, name, speed, weight, purchasePrice: price, upgradeLevel: 0, comfort });
            updateUI();
            renderShop();
            showNotification(`æˆåŠŸè´­ä¹° ${name}ï¼`);
        }

        function startRoute() {
            const trainId = parseFloat(document.getElementById('routeTrainSelect').value);
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            if (!train || !selectedStartCity || !selectedEndCity) return;
            if (!isCityUnlocked(selectedStartCity.name) || !isCityUnlocked(selectedEndCity.name)) { showNotification('è¯·å…ˆè§£é”æ‰€é€‰åŸå¸‚ï¼'); return; }
            
            // æ£€æŸ¥ç«è½¦æ˜¯å¦å·²åœ¨è¿è¥ä¸­
            if (gameState.runningTrains.some(rt => rt.trainId === trainId && !rt.paused)) {
                showNotification('è¯¥ç«è½¦å·²åœ¨è¿è¥ä¸­ï¼');
                return;
            }
            
            const distance = calculateDistance(selectedStartCity, selectedEndCity);
            const earnings = calculateEarnings(train, distance);
            const time = calculateTime(train, distance);
            const cost = Math.round(calculateWeight(train) * distance * 0.01);
            if (gameState.gold < cost) { showNotification('é‡‘å¸ä¸è¶³ä»¥æ”¯ä»˜è¿è¥æˆæœ¬ï¼'); return; }
            
            gameState.gold -= cost;
            gameState.runningTrains.push({ trainId: train.id, startCity: selectedStartCity.name, endCity: selectedEndCity.name, distance, earnings, totalTime: time, remainingTime: time, startTime: Date.now() });
            updateUI();
            renderRoutePanel();
            showNotification(`${train.name} å·²å‡ºå‘ï¼`);
        }

        function cancelRoute(index) {
            const rt = gameState.runningTrains[index];
            if (!rt) return;
            const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
            gameState.runningTrains.splice(index, 1);
            updateUI();
            renderRightPanel();
            renderRunningTrains();
            showNotification(`${train ? train.name : 'ç«è½¦'} çš„è¿è¥å·²å–æ¶ˆï¼`);
        }

        function hireEmployee() {
            if (gameState.employees.length >= 66) { showNotification('å‘˜å·¥æ•°é‡å·²è¾¾ä¸Šé™(66å)ï¼'); return; }
            if (gameState.gold < 1000) { showNotification('é‡‘å¸ä¸è¶³ï¼'); return; }
            gameState.gold -= 1000;
            const types = ['income', 'speed', 'weight'];
            gameState.employees.push({ id: Date.now() + Math.random(), name: employeeNames[Math.floor(Math.random() * employeeNames.length)], type: types[Math.floor(Math.random() * types.length)], level: 1, trainId: null });
            updateUI();
            renderEmployeeList();
            showNotification('æˆåŠŸæ‹›è˜å‘˜å·¥ï¼');
        }

        function upgradeEmployee(empId) {
            const emp = gameState.employees.find(e => e.id === empId);
            if (!emp || emp.level >= 40) return;
            const cost = calculateUpgradeCost(emp.level);
            if (gameState.points < cost) { showNotification('ç‚¹å·ä¸è¶³ï¼'); return; }
            gameState.points -= cost;
            emp.level++;
            updateUI();
            showEmployeeDetail();
            showNotification(`${emp.name} å‡çº§æˆåŠŸï¼`);
        }

        function fireEmployee(empId) {
            const emp = gameState.employees.find(e => e.id === empId);
            if (!emp) return;
            const refundPoints = calculateTotalUpgradeCost(emp.level);
            gameState.employees = gameState.employees.filter(e => e.id !== empId);
            gameState.points += refundPoints;
            updateUI();
            renderEmployeeList();
            showNotification(`${emp.name} å·²è¾é€€ï¼Œè¿”è¿˜ ${refundPoints} ç‚¹å·ï¼`);
        }

        function upgradeIncomeBonus() {
            if (gameState.points < 3000) { showNotification('ç‚¹å·ä¸è¶³ï¼'); return; }
            gameState.points -= 3000;
            gameState.consumedPoints += 3000;
            gameState.incomeBonus++;
            updateUI();
            renderUpgradePanel();
            showNotification(`æ”¶ç›ŠåŠ æˆæå‡è‡³ +${gameState.incomeBonus}%ï¼`);
        }

        function upgradeTrain(trainId) {
            const train = gameState.ownedTrains.find(t => t.id === trainId);
            if (!train) return;
            if (isTrainRestricted(train)) {
                showNotification('è¯¥ç«è½¦éœ€è¦è¾¾åˆ°54çº§æ‰èƒ½è¿›è¡Œå‡çº§ï¼');
                return;
            }
            const currentLevel = train.upgradeLevel || 0;
            if (currentLevel >= 20) { showNotification('å·²è¾¾æœ€é«˜ç­‰çº§ï¼'); return; }
            const cost = calculateTrainUpgradeCost(currentLevel + 1);
            if (gameState.points < cost) { showNotification('ç‚¹å·ä¸è¶³ï¼'); return; }
            gameState.points -= cost;
            train.upgradeLevel = currentLevel + 1;
            updateUI();
            showTrainUpgradeDetail();
            showNotification(`${train.name} æ”¹é€ å‡çº§æˆåŠŸï¼`);
        }
        
        function isTrainRestricted(train) {
            if (train.fromRedeemCode && train.name === 'é©¬å¹´çºªå¿µå·' && gameState.level < 54) {
                return true;
            }
            return false;
        }

        function redeemCode() {
            const code = document.getElementById('redeemCodeInput').value.trim().toLowerCase();
            if (!code) { showNotification('è¯·è¾“å…¥å…‘æ¢ç ï¼'); return; }
            if (gameState.usedRedeemCodes && gameState.usedRedeemCodes.includes(code)) { showNotification('è¯¥å…‘æ¢ç å·²ä½¿ç”¨ï¼'); return; }
            if (!redeemCodes[code]) { showNotification('æ— æ•ˆçš„å…‘æ¢ç ï¼'); return; }
            
            let rewardMsg = [];
            if (redeemCodes[code].points > 0) {
                gameState.points += redeemCodes[code].points;
                rewardMsg.push(`${redeemCodes[code].points} ç‚¹å·`);
            }
            if (redeemCodes[code].reformStones > 0) {
                gameState.reformStones += redeemCodes[code].reformStones;
                rewardMsg.push(`${redeemCodes[code].reformStones} æ”¹é€ çŸ³`);
            }
            if (redeemCodes[code].train) {
                const trainName = redeemCodes[code].train;
                const trainDataItem = trainData.zodiac.find(t => t.name === trainName);
                if (trainDataItem) {
                    gameState.ownedTrains.push({
                        id: Date.now() + Math.random(),
                        type: 'zodiac',
                        name: trainName,
                        speed: trainDataItem.speed,
                        weight: trainDataItem.weight,
                        purchasePrice: trainDataItem.price,
                        comfort: trainDataItem.comfort || 100,
                        fromRedeemCode: true
                    });
                    rewardMsg.push(`${trainName} ç«è½¦`);
                }
            }
            if (!gameState.usedRedeemCodes) gameState.usedRedeemCodes = [];
            gameState.usedRedeemCodes.push(code);
            updateUI();
            renderRedeemPanel();
            showNotification(`å…‘æ¢æˆåŠŸï¼è·å¾— ${rewardMsg.join(', ')}ï¼`);
        }

        function showAssignModal(empId) {
            const emp = gameState.employees.find(e => e.id === empId);
            document.getElementById('assignEmployeeList').innerHTML = `
                <div style="margin-bottom:15px;font-size:14px;"><strong>${emp.name}</strong> - ${employeeTypes[emp.type].name}</div>
                <div style="margin-bottom:12px;"><button class="btn btn-secondary" onclick="assignEmployee(${emp.id}, null)" style="width:100%;">å–æ¶ˆåˆ†é…</button></div>
                ${gameState.ownedTrains.map(train => {
                    const restricted = isTrainRestricted(train);
                    return `<div class="train-card ${restricted ? 'disabled' : ''}" onclick="${restricted ? '' : `assignEmployee(${emp.id}, ${train.id})`}" style="${restricted ? 'opacity:0.5;cursor:not-allowed;' : ''}">
                        <div class="train-name">${train.name}</div>
                        <span class="train-type type-${train.type}">${trainTypes[train.type].name}</span>
                        ${restricted ? '<div style="color:var(--neon-orange);font-size:10px;margin-top:5px;">âš ï¸ éœ€è¦54çº§</div>' : ''}
                    </div>`;
                }).join('')}`;
            document.getElementById('employeeModal').classList.add('show');
        }

        function assignEmployee(empId, trainId) {
            if (trainId !== null) {
                const train = gameState.ownedTrains.find(t => t.id === trainId);
                if (isTrainRestricted(train)) {
                    showNotification('è¯¥ç«è½¦éœ€è¦è¾¾åˆ°54çº§æ‰èƒ½åˆ†é…å¸æœºï¼');
                    return;
                }
            }
            const emp = gameState.employees.find(e => e.id === empId);
            if (emp) emp.trainId = trainId;
            closeModal();
            showEmployeeDetail();
        }

        function closeModal() { document.getElementById('employeeModal').classList.remove('show'); }
        function closeOfflineModal() { document.getElementById('offlineModal').classList.remove('show'); }

        function manualSave() {
            saveGame();
            showNotification('ä¿å­˜æˆåŠŸï¼');
        }

        function confirmRestart() {
            document.getElementById('restartModal').classList.add('show');
        }

        function closeRestartModal() {
            document.getElementById('restartModal').classList.remove('show');
        }

        function restartGame() {
            localStorage.removeItem('railroadTycoon');
            gameState = {
                gold: 20000, points: 0, level: 1, exp: 0, expToNext: 500,
                employees: [], runningTrains: [], ownedTrains: [],
                unlockedCities: ["å¹¿å·", "æ·±åœ³"], dailyPointsEarned: 0,
                lastDailyReset: null, lastSaveTime: null, lastOnlineTime: null,
                totalEarnings: 0, incomeBonus: 0, consumedPoints: 0,
                usedRedeemCodes: []
            };
            selectedStartCity = null;
            selectedEndCity = null;
            gameState.ownedTrains.push({ id: Date.now() + Math.random(), type: 'normal', name: 'å’Œè°å·', speed: 80, weight: 600, purchasePrice: 5000, upgradeLevel: 0, comfort: 100 });
            closeRestartModal();
            updateUI();
            updateLevelUI();
            renderTrainList();
            renderRightPanel();
            showNotification('æ¸¸æˆå·²é‡æ–°å¼€å§‹ï¼');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 2000);
        }

        // ==================== æ¸¸æˆå¾ªç¯ ====================
        function gameLoop() {
            updateWeather();
            gameState.runningTrains.forEach(rt => {
                rt.remainingTime--;
                if (rt.remainingTime <= 0) {
                    gameState.gold += rt.earnings;
                    gameState.totalEarnings += rt.earnings;
                    addExp(Math.floor(rt.distance / 10));
                    checkDailyPointsReset();
                    if (gameState.dailyPointsEarned < 1500) {
                        const points = Math.floor(Math.random() * 5) + 1;
                        const canEarn = Math.min(points, 1500 - gameState.dailyPointsEarned);
                        gameState.points += canEarn;
                        gameState.dailyPointsEarned += canEarn;
                    }
                    if (gameState.dailyReformStonesEarned < 300 && Math.random() < 0.05) {
                        const stones = Math.floor(Math.random() * 5) + 1;
                        const canEarnStones = Math.min(stones, 300 - gameState.dailyReformStonesEarned);
                        gameState.reformStones += canEarnStones;
                        gameState.dailyReformStonesEarned += canEarnStones;
                        showNotification('è·å¾— ' + canEarnStones + ' ä¸ªæ”¹é€ çŸ³ï¼');
                    }
                    const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
                    if (train) {
                        const cost = Math.round(calculateWeight(train) * rt.distance * 0.01);
                        if (gameState.gold >= cost) {
                            gameState.gold -= cost;
                            // é‡æ–°è®¡ç®—æ—¶é—´å’Œæ”¶ç›Šï¼Œä½¿å‘˜å·¥å’Œæ”¹é€ åŠ æˆç«‹å³ç”Ÿæ•ˆ
                            rt.totalTime = calculateTime(train, rt.distance);
                            rt.earnings = calculateEarnings(train, rt.distance);
                            rt.remainingTime = rt.totalTime;
                        } else {
                            rt.paused = true;
                            rt.remainingTime = 0;
                        }
                    }
                }
            });
            updateUI();
            renderRightPanel();
            // å¦‚æœè¿è¥çŠ¶æ€é¢æ¿å¯è§ï¼Œå®æ—¶æ›´æ–°
            const runningPanel = document.getElementById('runningPanel');
            if (runningPanel && runningPanel.style.display !== 'none') {
                renderRunningTrains();
            }
        }

        // ==================== å­˜æ¡£ç³»ç»Ÿ ====================
        function saveGame() {
            // æ•°æ®æ ¡éªŒï¼šæ£€æµ‹å¼‚å¸¸æ•°å€¼
            if (gameState.gold < 0) {
                gameState.gold = 0;
                showNotification('æ£€æµ‹åˆ°å¼‚å¸¸æ•°æ®ï¼Œå·²é‡ç½®é‡‘å¸ï¼');
            }
            if (gameState.level < 1) {
                gameState.level = 1;
            }
            if (gameState.reformStones < 0 || gameState.reformStones > 100000) {
                gameState.reformStones = 0;
                showNotification('æ£€æµ‹åˆ°å¼‚å¸¸æ•°æ®ï¼Œå·²é‡ç½®æ”¹é€ çŸ³ï¼');
            }
            gameState.lastSaveTime = new Date().toISOString();
            localStorage.setItem('railroadTycoon', JSON.stringify(gameState));
            document.getElementById('lastSave').textContent = 'ä¸Šæ¬¡ä¿å­˜: ' + new Date().toLocaleTimeString();
        }

        function loadGame() {
            const saved = localStorage.getItem('railroadTycoon');
            if (saved) {
                const loadedState = JSON.parse(saved);
                gameState = { ...gameState, ...loadedState };
                if (!gameState.unlockedCities) gameState.unlockedCities = ["å¹¿å·", "æ·±åœ³"];
                if (gameState.incomeBonus === undefined) gameState.incomeBonus = 0;
                if (gameState.consumedPoints === undefined) gameState.consumedPoints = 0;
                if (!gameState.usedRedeemCodes) gameState.usedRedeemCodes = [];
                gameState.ownedTrains.forEach(train => { if (train.upgradeLevel === undefined) train.upgradeLevel = 0; });
                // æ”¹é€ çŸ³ç³»ç»Ÿå…¼å®¹
                if (gameState.reformStones === undefined) gameState.reformStones = 0;
                if (gameState.dailyReformStonesEarned === undefined) gameState.dailyReformStonesEarned = 0;
                gameState.ownedTrains.forEach(train => { 
                    if (train.reformLevel === undefined) train.reformLevel = 0;
                    if (train.goldReformLevel === undefined) train.goldReformLevel = 0;
                });
                
                // æ¢å¤è¿è¡Œä¸­çš„ç«è½¦æ•°æ®,è€Œä¸æ˜¯æ¸…ç©º
                if (!gameState.runningTrains) gameState.runningTrains = [];
                
                // è®¡ç®—ç¦»çº¿æœŸé—´çš„ç«è½¦è¿è¥
                if (gameState.lastOnlineTime && gameState.runningTrains.length > 0) {
                    const offlineTime = (Date.now() - new Date(gameState.lastOnlineTime).getTime()) / 1000;
                    
                    if (offlineTime > 10) {
                        let totalOfflineEarnings = 0;
                        
                        // å¤„ç†ç¦»çº¿æœŸé—´çš„ç«è½¦è¿è¥
                        const maxOfflineSeconds = Math.min(Math.floor(offlineTime), 3600); // æœ€å¤šè®¡ç®—1å°æ—¶
                        for (let i = 0; i < maxOfflineSeconds; i++) {
                            gameState.runningTrains.forEach(rt => {
                                if (!rt.paused) {
                                    rt.remainingTime--;
                                    if (rt.remainingTime <= 0) {
                                        totalOfflineEarnings += rt.earnings;
                                        gameState.totalEarnings += rt.earnings;
                                        
                                        const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
                                        if (train) {
                                            const cost = Math.round(calculateWeight(train) * rt.distance * 0.01);
                                            if (gameState.gold >= cost) {
                                                gameState.gold -= cost;
                                                rt.remainingTime = rt.totalTime;
                                            } else {
                                                rt.paused = true;
                                                rt.remainingTime = 0;
                                            }
                                        }
                                    }
                                }
                            });
                        }
                        
                        // æ˜¾ç¤ºç¦»çº¿æ”¶ç›Š
                        if (totalOfflineEarnings > 0) {
                            gameState.gold += totalOfflineEarnings;
                            document.getElementById('offlineEarnings').textContent = formatNumber(totalOfflineEarnings);
                            document.getElementById('offlineModal').classList.add('show');
                        }
                    }
                }
            }
        }

        // ==================== é˜²ä½œå¼Šæœºåˆ¶ ====================
        (function() {
            // 1. ç¦ç”¨å³é”®èœå•
            document.addEventListener('contextmenu', e => e.preventDefault());
            
            // 2. ç¦ç”¨F12å’Œå¼€å‘è€…å·¥å…·å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                if (e.key === 'F12' || 
                    (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')) ||
                    (e.ctrlKey && (e.key === 'U' || e.key === 'u' || e.key === 'S' || e.key === 's'))) {
                    e.preventDefault();
                    showNotification('ç¦æ­¢è®¿é—®å¼€å‘è€…å·¥å…·ï¼');
                    return false;
                }
            });
            
            // 3. æ£€æµ‹å¼€å‘è€…å·¥å…·æ‰“å¼€ï¼ˆå»¶è¿Ÿ5ç§’å¯åŠ¨ï¼Œé¿å…åˆå§‹åŒ–æ—¶è¯¯æŠ¥ï¼‰
            let devtools = { open: false, initialized: false };
            const threshold = 160;
            
            setTimeout(function() {
                devtools.initialized = true;
            }, 5000);
            
            setInterval(function() {
                if (!devtools.initialized) return;
                if (window.outerWidth - window.innerWidth > threshold || 
                    window.outerHeight - window.innerHeight > threshold) {
                    if (!devtools.open) {
                        devtools.open = true;
                        showNotification('æ£€æµ‹åˆ°å¼€å‘è€…å·¥å…·ï¼Œè¯·å…³é—­ï¼');
                    }
                } else {
                    devtools.open = false;
                }
            }, 500);
            
            // 4. æ§åˆ¶å°è­¦å‘Š
            console.log('%cè­¦å‘Šï¼', 'color: red; font-size: 40px; font-weight: bold;');
            console.log('%cæ­¤æµè§ˆå™¨åŠŸèƒ½ä»…ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚è¯·å‹¿åœ¨æ­¤å¤„ç²˜è´´ä»»ä½•å†…å®¹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„è´¦å·è¢«å°ç¦ã€‚', 'font-size: 16px;');
        })();
        
        // ==================== åˆå§‹åŒ– ====================
        function init() {
            loadGame();
            if (gameState.ownedTrains.length === 0) {
                gameState.ownedTrains.push({ id: Date.now() + Math.random(), type: 'normal', name: 'å’Œè°å·', speed: 80, weight: 600, purchasePrice: 5000, upgradeLevel: 0, comfort: 100 });
            }
            gameState.ownedTrains.forEach(train => {
                if (train.comfort === undefined) {
                    const trainInfo = trainData[train.type] ? trainData[train.type].find(t => t.name === train.name) : null;
                    train.comfort = trainInfo ? trainInfo.comfort : 100;
                }
            });
            updateUI();
            updateLevelUI();
            renderTrainList();
            renderRightPanel();
            
            initMapControls();
            
            let lastTime = Date.now();
            
            // æ—¶é—´åŠ é€Ÿæ£€æµ‹å˜é‡
            let loopCount = 0;
            let loopCheckTime = Date.now();
            
            function gameLoopWithBackground() {
                const now = Date.now();
                const delta = now - lastTime;
                
                // æ—¶é—´åŠ é€Ÿæ£€æµ‹ï¼šæ¯ç§’æ£€æŸ¥å¾ªç¯æ¬¡æ•°
                loopCount++;
                if (now - loopCheckTime >= 1000) {
                    if (loopCount > 2) {
                        // æ¯ç§’æ‰§è¡Œè¶…è¿‡2æ¬¡å¾ªç¯ï¼Œå¯èƒ½åœ¨ä½¿ç”¨åŠ é€Ÿå™¨
                        showNotification('æ£€æµ‹åˆ°å¼‚å¸¸æ¸¸æˆé€Ÿåº¦ï¼');
                    }
                    loopCount = 0;
                    loopCheckTime = now;
                }
                
                if (delta > 1000) {
                    const missedSeconds = Math.floor(delta / 1000);
                    for (let i = 0; i < missedSeconds; i++) gameLoop();
                }
                lastTime = now;
                gameLoop();
            }
            
            setInterval(gameLoopWithBackground, 1000);
            setInterval(() => { saveGame(); gameState.lastOnlineTime = new Date().toISOString(); }, 30000);
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    if (gameState.lastOnlineTime) {
                        const offlineTime = (Date.now() - new Date(gameState.lastOnlineTime).getTime()) / 1000;
                        if (offlineTime > 5) {
                            const missedSeconds = Math.min(Math.floor(offlineTime), 3600);
                            for (let i = 0; i < missedSeconds; i++) {
                                gameState.runningTrains.forEach(rt => {
                                    if (!rt.paused) {
                                        rt.remainingTime--;
                                        if (rt.remainingTime <= 0) {
                                            gameState.gold += rt.earnings;
                                            gameState.totalEarnings += rt.earnings;
                                            const train = gameState.ownedTrains.find(t => t.id === rt.trainId);
                                            if (train) {
                                                const cost = Math.round(calculateWeight(train) * rt.distance * 0.01);
                                                if (gameState.gold >= cost) {
                                                    gameState.gold -= cost;
                                                    rt.remainingTime = rt.totalTime;
                                                } else {
                                                    rt.paused = true;
                                                    rt.remainingTime = 0;
                                                }
                                            }
                                        }
                                    }
                                });
                            }
                            showNotification(`ç¦»çº¿è¡¥å¿ï¼š${missedSeconds}ç§’çš„è¿è¥æ”¶ç›Šï¼`);
                        }
                    }
                    gameState.lastOnlineTime = new Date().toISOString();
                    saveGame();
                } else {
                    gameState.lastOnlineTime = new Date().toISOString();
                    saveGame();
                }
            });
            
            window.addEventListener('beforeunload', () => { 
                gameState.lastOnlineTime = new Date().toISOString(); 
                saveGame(); 
            });
            
            window.addEventListener('pagehide', () => { 
                gameState.lastOnlineTime = new Date().toISOString(); 
                saveGame(); 
            });
        }

        init();
    </script>
    
    <!-- æ¸¸æˆåº•éƒ¨è¯´æ˜ -->
    <div style="position:fixed;bottom:0;left:0;right:0;background:linear-gradient(180deg,transparent,rgba(10,10,15,0.95));padding:15px;text-align:center;font-family:'Share Tech Mono',monospace;font-size:12px;color:var(--fg-secondary);z-index:100;pointer-events:none;">
        <span style="background:var(--gradient-rainbow);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;background-size:200% 100%;animation:rainbowText 3s linear infinite;">æ¸¸æˆåˆ¶ä½œè€…ï¼šé¡¶çº§èŒæ–°</span>
    </div>
<!--å®¢æœ å¼€å§‹-->
<script src="//g8hh.github.io/static/js/jquery.min.js"></script>
<link rel="stylesheet" href="//g8hh.github.io/static/css/kf.css" type="text/css" media="screen" charset="utf-8">
<script src="//g8hh.github.io/static/js/kf.js"></script>
<!-- å®¢æœ ç»“æŸ -->
<!--ç«™é•¿ç»Ÿè®¡-->
    <div style="display: none">
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?828597e93cee632465679b7ef35edfd5";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>    </div>
</body>
</html>
